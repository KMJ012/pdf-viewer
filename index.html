<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Viewer</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23dc2626'%3E%3Cpath d='M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z'/%3E%3Ctext x='12' y='16' text-anchor='middle' fill='white' font-size='6' font-weight='bold' font-family='Arial'%3EPDF%3C/text%3E%3C/svg%3E" type="image/svg+xml">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: background-color 0.4s ease, color 0.4s ease, border-color 0.4s ease;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: rgb(40, 40, 40);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: background-color 0.4s ease;
        }

        /* ë¼ì´íŠ¸ ëª¨ë“œ */
        body.light-theme {
            background: #f8f9fa;
        }

        body.light-theme .toolbar {
            background: rgb(248, 249, 250);
            border-bottom: 1px solid #e1e5e9;
            color: #202124;
        }

        body.light-theme .file-title {
            color: #202124;
        }

        body.light-theme .toolbar-btn {
            color: #5f6368;
        }

        body.light-theme .toolbar-btn:hover {
            background: rgba(60, 64, 67, 0.08);
            color: #202124;
        }

        body.light-theme .toolbar-input {
            background: white;
            border: 1px solid #dadce0;
            color: #202124;
        }

        body.light-theme .toolbar-input:hover {
            background: #f8f9fa;
            border-color: #dadce0;
        }

        body.light-theme .toolbar-input:focus {
            background: white;
            border-color: #4285f4;
        }

        body.light-theme .zoom-select {
            background: white;
            border: 1px solid #dadce0;
            color: #202124;
        }

        body.light-theme .zoom-select:hover {
            background: #f8f9fa;
        }

        body.light-theme .zoom-select:focus {
            background: white;
            border-color: #4285f4;
        }

        body.light-theme .page-divider {
            color: #5f6368;
        }

        body.light-theme .sidebar {
            background: rgb(248, 249, 250);
            border-right: 1px solid #e1e5e9;
        }

        body.light-theme .icon-panel {
            background: rgb(241, 243, 244);
            border-right: 1px solid #e1e5e9;
        }

        body.light-theme .icon-btn {
            color: #5f6368;
        }

        body.light-theme .icon-btn:hover {
            background: rgba(60, 64, 67, 0.08);
            color: #202124;
        }

        body.light-theme .icon-btn.active {
            background: #4285f4;
            color: #fff;
        }

        body.light-theme .folder-section {
            background: rgb(248, 249, 250);
        }

        body.light-theme .folder-header {
            border-bottom: 1px solid #e1e5e9;
        }

        body.light-theme .folder-title {
            color: #202124;
        }

        body.light-theme .folder-tree {
            color: #5f6368;
        }

        body.light-theme .folder-item:hover {
            background: rgba(60, 64, 67, 0.08);
        }

        body.light-theme .folder-item.selected {
            background: #4285f4;
            color: white;
        }

        body.light-theme .folder-item.pdf-file {
            color: #202124;
        }

        body.light-theme .folder-empty {
            color: #5f6368;
            background: rgba(60, 64, 67, 0.04);
        }

        body.light-theme .folder-empty:hover {
            background: rgba(66, 133, 244, 0.08);
            color: #202124;
        }

        body.light-theme .thumbnail-item {
            background: white;
            border: 2px solid #e1e5e9;
        }

        body.light-theme .thumbnail-item:hover {
            border-color: #4285f4;
        }

        body.light-theme .loading-thumbnails {
            color: #5f6368;
        }

        body.light-theme .pdf-container {
            background: rgb(245, 245, 245);
        }

        body.light-theme .loading {
            color: #5f6368;
        }

        body.light-theme .properties-dialog {
            background: white;
            color: #202124;
        }

        body.light-theme .properties-header {
            border-bottom: 1px solid #e1e5e9;
        }

        body.light-theme .properties-title {
            color: #202124;
        }

        body.light-theme .property-group:not(:last-child)::after {
            background: linear-gradient(90deg, transparent, #e1e5e9, transparent);
        }

        body.light-theme .property-label {
            color: #5f6368;
        }

        body.light-theme .property-value {
            color: #202124;
        }

        body.light-theme .properties-footer {
            border-top: 1px solid #e1e5e9;
        }

        body.light-theme .toast {
            background: #202124;
            color: white;
        }

        body.light-theme .upload-area {
            background: white;
            border: 2px dashed #dadce0;
        }

        body.light-theme .upload-area:hover {
            border-color: #4285f4;
            background: #f8f9fa;
        }

        body.light-theme .upload-icon {
            color: #9aa0a6;
        }

        body.light-theme .upload-text {
            color: #5f6368;
        }

        body.light-theme .folder-selected-message {
            background: white;
            border: 2px solid #e8f0fe;
        }

        body.light-theme .folder-selected-text {
            color: #5f6368;
        }

        body.light-theme .folder-selected-subtitle {
            color: #9aa0a6;
        }

        /* ë¼ì´íŠ¸ í…Œë§ˆì—ì„œ ì‚¬ìš©ë²• ì„¤ëª… í…ìŠ¤íŠ¸ ìƒ‰ìƒ */
        body.light-theme .upload-area div[style*="color: #888"] {
            color: #9aa0a6 !important;
        }

        body.light-theme .upload-area strong[style*="color: #ccc"] {
            color: #5f6368 !important;
        }

        /* ìƒë‹¨ íˆ´ë°” */
        .toolbar {
            background: rgb(60, 60, 60);
            border-bottom: 1px solid #333;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 16px;
            flex-shrink: 0;
            height: 63px;
            box-sizing: border-box;
            z-index: 1000;
        }

        .toolbar-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .toolbar-section.left {
            flex: 1;
            justify-content: flex-start;
        }

        .toolbar-section.center {
            flex: 0 0 auto;
            justify-content: center;
        }

        .toolbar-section.right {
            flex: 1;
            justify-content: flex-end;
        }

        .toolbar-divider {
            color: #888;
            font-size: 14px;
            margin: 0 4px;
        }

        .file-title {
            color: #fff;
            font-size: 14px;
            font-weight: bold;
            max-width: 350px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .fit-toggle-btn {
            background: transparent;
            border: none;
            border-radius: 50%;
            padding: 8px;
            font-size: 16px;
            cursor: pointer;
            color: #fff;
            transition: all 0.2s ease;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fit-toggle-btn:hover {
            background: rgba(75, 75, 75, 0.5);
        }

        .fit-toggle-btn.active {
            background: #4285f4;
            color: #fff;
        }

        .fit-toggle-btn.active:hover {
            background: #3367d6;
        }

        .toolbar-btn.capture-mode {
            background: #ff6b6b;
            color: #fff;
        }

        .toolbar-btn.capture-mode:hover {
            background: #ff5252;
        }

        /* ë©”ì¸ ë ˆì´ì•„ì›ƒ ì»¨í…Œì´ë„ˆ */
        .main-layout {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* ì‚¬ì´ë“œë°” */
        .sidebar {
            width: 0;
            background: rgb(50, 50, 50);
            border-right: 1px solid #333;
            transition: width 0.3s ease;
            overflow: hidden;
            flex-shrink: 0;
            display: flex;
            flex-direction: row;
            position: relative;
        }

        .sidebar.icon-panel-open {
            width: 48px;
        }

        .sidebar.icon-panel-open.thumbnails-open {
            width: 318px; /* í´ë”ì™€ ë™ì¼í•œ í¬ê¸°ë¡œ ê³ ì • */
        }

        .sidebar.icon-panel-open.folder-open {
            width: 318px; /* 48px (ì•„ì´ì½˜) + 270px (í´ë”) */
        }

        .sidebar.icon-panel-open.thumbnails-open.folder-open {
            width: 318px; /* ê³ ì • í¬ê¸° ìœ ì§€ */
        }

        /* ì•„ì´ì½˜ íŒ¨ë„ */
        .icon-panel {
            width: 48px;
            background: rgb(45, 45, 45);
            border-right: 1px solid #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 0;
            flex-shrink: 0;
            opacity: 0;
            transform: translateX(-100%);
            transition: all 0.3s ease;
            z-index: 200;
            pointer-events: auto;
        }

        .sidebar.icon-panel-open .icon-panel {
            opacity: 1;
            transform: translateX(0);
            pointer-events: auto;
        }

        .icon-btn {
            width: 36px;
            height: 36px;
            background: transparent;
            border: none;
            border-radius: 4px;
            color: #ccc;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 4px;
            pointer-events: auto;
        }

        .icon-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .icon-btn.active {
            background: #4285f4;
            color: #fff;
        }

        .icon-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            pointer-events: none;
        }

        /* ì¸ë„¤ì¼ ì„¹ì…˜ */
        .thumbnails-section {
            width: 270px;
            flex-shrink: 0;
            overflow-y: auto;
            padding: 16px;
            padding-top: 8px;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .sidebar.thumbnails-open .thumbnails-section {
            display: block;
            opacity: 1;
        }

        /* í´ë” íƒìƒ‰ê¸° ì„¹ì…˜ */
        .folder-section {
            width: 270px;
            flex-shrink: 0;
            overflow-y: auto;
            padding: 8px;
            background: rgb(50, 50, 50);
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .sidebar.folder-open .folder-section {
            display: block;
            opacity: 1;
        }

        .folder-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 4px;
            margin-bottom: 8px;
            border-bottom: 1px solid #444;
        }

        .folder-title {
            color: #ccc;
            font-size: 13px;
            font-weight: bold;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .folder-select-btn {
            background: #4285f4;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 4px 8px;
            font-size: 11px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .folder-select-btn:hover {
            background: #3367d6;
        }

        .folder-tree {
            color: #ccc;
            font-size: 13px;
            line-height: 1.4;
        }

        .folder-item {
            display: flex;
            align-items: center;
            padding: 2px 4px;
            cursor: pointer;
            border-radius: 3px;
            user-select: none;
            transition: background 0.1s ease;
        }

        .folder-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .folder-item.selected {
            background: #4285f4;
            color: white;
        }

        .folder-item.pdf-file {
            color: #fff;
        }

        .folder-item.pdf-file:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .folder-item.pdf-file.selected {
            background: #4285f4;
        }

        .folder-indent {
            margin-left: 16px;
        }

        .folder-icon {
            width: 16px;
            height: 16px;
            margin-right: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            flex-shrink: 0;
        }

        .folder-icon.expandable {
            cursor: pointer;
            color: #888;
        }

        .folder-icon.expandable:hover {
            color: #ccc;
        }

        .folder-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .folder-empty {
            color: #888;
            text-align: center;
            padding: 20px;
            font-size: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px dashed transparent;
            user-select: none;
        }

        .folder-empty:hover {
            background: rgba(66, 133, 244, 0.2);
            border-color: #4285f4;
            color: #ccc;
            transform: scale(1.02);
        }

        .folder-empty.dragover {
            background: rgba(66, 133, 244, 0.3);
            border-color: #4285f4;
            color: #fff;
            transform: scale(1.05);
        }

        .thumbnails-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .thumbnail-item {
            position: relative;
            border: 2px solid transparent;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: #444;
            overflow: hidden;
        }

        .thumbnail-item:hover {
            border-color: #4285f4;
        }

        .thumbnail-item.active {
            border-color: #4285f4;
            box-shadow: 0 0 8px rgba(66, 133, 244, 0.5);
        }

        .thumbnail-canvas {
            width: 100%;
            height: auto;
            display: block;
        }

        .thumbnail-label {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            font-size: 12px;
            text-align: center;
            padding: 4px;
        }

        .loading-thumbnails {
            color: #ccc;
            text-align: center;
            padding: 20px;
            font-size: 14px;
        }

        /* ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: margin-left 0.3s ease;
        }

        .toolbar-btn {
            background: transparent;
            border: none;
            border-radius: 50%;
            padding: 8px;
            font-size: 16px;
            cursor: pointer;
            color: #fff;
            transition: all 0.2s ease;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #propertiesBtn {
            font-size: 20px;
            font-weight: bold;
        }

        .toolbar-btn:hover {
            background: rgba(75, 75, 75, 0.5);
        }

        .toolbar-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .toolbar-input {
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            padding: 5px 8px;
            font-size: 13px;
            min-width: 35px;
            text-align: center;
            color: #fff;
            background: rgb(30, 30, 30);
            transition: all 0.2s ease;
        }

        #pageInput {
            margin-right: -10px;
        }

        #zoomOut, #zoomIn {
            font-size: 25px;
            transition: color 0.2s ease;
        }

        #zoomOut.disabled, #zoomIn.disabled {
            color: rgb(129, 129, 129);
            cursor: not-allowed;
        }

        #zoomOut {
            margin-right: -10px;
        }

        #zoomIn {
            margin-left: -10px;
        }

        .toolbar-input:focus {
            outline: none;
            border-color: #4285f4;
            background: rgb(35, 35, 35);
        }

        .toolbar-input:hover {
            background: rgb(35, 35, 35);
        }

        /* ìˆ«ì ì…ë ¥ í•„ë“œì˜ ì¦ê°€/ê°ì†Œ ë²„íŠ¼ ìˆ¨ê¸°ê¸° */
        .toolbar-input::-webkit-outer-spin-button,
        .toolbar-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            appearance: none;
            margin: 0;
        }

        .toolbar-input[type=number] {
            -moz-appearance: textfield;
            appearance: textfield;
        }

        .zoom-select {
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            padding: 5px 8px;
            font-size: 13px;
            background: rgb(30, 30, 30);
            color: #fff;
            cursor: pointer;
            min-width: 70px;
            text-align: center;
            transition: all 0.2s ease;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        .zoom-select:hover {
            background: rgb(35, 35, 35);
        }

        .zoom-select:focus {
            outline: none;
            border-color: #4285f4;
            background: rgb(35, 35, 35);
        }

        .zoom-select option {
            background: rgb(30, 30, 30);
            color: #fff;
        }

        .page-divider {
            color: #ccc;
            font-size: 13px;
            margin: 0 6px;
        }

        /* ì—…ë¡œë“œ ì˜ì—­ - ê¸°ë³¸ ë‹¤í¬ëª¨ë“œ */
        .upload-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgb(50, 50, 50);
            border: 2px dashed #555;
            margin: 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #ccc;
        }

        .upload-area:hover {
            border-color: #4285f4;
            background: rgb(45, 45, 45);
        }

        .upload-area.dragover {
            border-color: #4285f4;
            background: rgba(66, 133, 244, 0.1);
        }

        .upload-icon {
            font-size: 3em;
            color: #888;
            margin-bottom: 16px;
        }

        .upload-text {
            font-size: 16px;
            color: #ccc;
            margin-bottom: 16px;
        }

        .upload-btn {
            background: #4285f4;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .upload-btn:hover {
            background: #3367d6;
        }

        .file-input {
            display: none;
        }

        /* í´ë” ì„ íƒ ì™„ë£Œ ë©”ì‹œì§€ - ê¸°ë³¸ ë‹¤í¬ëª¨ë“œ */
        .folder-selected-message {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgb(50, 50, 50);
            border: 2px solid #444;
            margin: 20px;
            border-radius: 8px;
            padding: 40px;
            color: #ccc;
        }

        .folder-selected-icon {
            font-size: 4em;
            color: #4285f4;
            margin-bottom: 20px;
        }

        .folder-selected-text {
            font-size: 18px;
            color: #ccc;
            margin-bottom: 16px;
            text-align: center;
        }

        .folder-selected-subtitle {
            font-size: 14px;
            color: #888;
            text-align: center;
            line-height: 1.6;
        }

        /* PDF ë·°ì–´ */
        .pdf-viewer {
            display: none;
            flex: 1;
            overflow: hidden;
        }

        .pdf-container {
            flex: 1;
            background: rgb(40, 40, 40);
            overflow: auto;
            position: relative;
        }

        .pdf-container.fit-page {
            overflow: hidden; /* í˜ì´ì§€ ë§ì¶¤ ëª¨ë“œì—ì„œëŠ” ìŠ¤í¬ë¡¤ ì™„ì „ ê¸ˆì§€ */
        }

        .pdf-wrapper {
            position: relative;
            min-width: 100%;
            min-height: 100%;
            display: flex;
            align-items: flex-start;
            justify-content: flex-start;
        }

        .pdf-content {
            position: relative;
            display: inline-block;
            margin: 10px; /* ì—¬ë°±ì„ 20pxì—ì„œ 10pxë¡œ ì¤„ì„ */
        }

        #pdfImage {
            display: block;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            max-width: none;
            max-height: none;
            position: relative;
            z-index: 1;
            transition: transform 0.2s ease;
            will-change: transform;
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
        }

        /* ìˆ¨ê²¨ì§„ ìº”ë²„ìŠ¤ (ë Œë”ë§ìš©) */
        #pdfCanvas {
            display: none;
            position: absolute;
            top: -9999px;
            left: -9999px;
        }

        .text-layer {
            position: absolute;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
            opacity: 1;
            line-height: 1.0;
            pointer-events: auto;
            z-index: 2;
            transition: transform 0.2s ease;
            will-change: transform;
        }

        .text-layer span {
            color: transparent;
            position: absolute;
            white-space: pre;
            cursor: text;
            transform-origin: 0% 0%;
            user-select: text;
            -webkit-user-select: text;
            -moz-user-select: text;
            font-family: sans-serif;
        }

        .text-layer span::selection {
            background: rgba(0, 100, 255, 0.3);
            color: rgb(166, 192, 215);
        }

        .text-layer span::-moz-selection {
            background: rgba(0, 100, 255, 0.3);
            color: rgb(166, 192, 215);
        }

        /* ìº¡ì³ ì˜¤ë²„ë ˆì´ */
        .capture-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            z-index: 10;
            cursor: crosshair;
            display: none;
            pointer-events: none;
        }

        .capture-overlay.active {
            display: block;
            pointer-events: auto;
        }

        .selection-area {
            position: absolute;
            border: 2px dashed #4285f4;
            background: rgba(66, 133, 244, 0.1);
            pointer-events: none;
            display: none;
        }

        .capture-guide {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 14px;
            z-index: 11;
            display: none;
        }

        .capture-guide.show {
            display: block;
        }

        /* ë¬¸ì„œ ì†ì„± ëª¨ë‹¬ */
        .properties-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .properties-modal.show {
            display: flex;
            opacity: 1;
        }

        .properties-dialog {
            background: rgb(41, 42, 45);
            border-radius: 8px;
            padding: 24px;
            max-width: 500px;
            min-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            color: #fff;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            transform: scale(0.8);
            transition: transform 0.3s ease;
        }

        .properties-modal.show .properties-dialog {
            transform: scale(1);
        }

        .properties-header {
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid #555;
        }

        .properties-title {
            font-size: 18px;
            font-weight: bold;
            color: #fff;
        }

        .properties-content {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .property-group {
            padding-bottom: 12px;
            margin-bottom: 12px;
            position: relative;
        }

        .property-group:not(:last-child)::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, #666, transparent);
        }

        .property-group:last-child {
            border-bottom: none;
            padding-bottom: 0;
            margin-bottom: 0;
        }

        .property-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 2px 0;
        }

        .property-label {
            min-width: 140px;
            font-size: 13px;
            color: #ccc;
            flex-shrink: 0;
        }

        .property-value {
            font-size: 13px;
            color: #fff;
            flex: 1;
            word-break: break-all;
        }

        .properties-footer {
            margin-top: 20px;
            padding-top: 12px;
            border-top: 1px solid #555;
            display: flex;
            justify-content: flex-end;
        }

        .properties-close-btn {
            background: #4285f4;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 8px 20px;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .properties-close-btn:hover {
            background: #3367d6;
        }

        /* í† ìŠ¤íŠ¸ ì•Œë¦¼ */
        .toast-container {
            position: fixed;
            top: 76px;
            right: 20px;
            z-index: 1000;
            pointer-events: none;
        }

        .toast {
            background: #323232;
            color: white;
            padding: 12px 16px;
            border-radius: 4px;
            font-size: 14px;
            margin-bottom: 8px;
            transform: translateX(400px);
            transition: all 0.3s ease;
            opacity: 0;
            max-width: 300px;
            word-wrap: break-word;
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }

        .toast.hide {
            transform: translateX(400px);
            opacity: 0;
        }

        /* ë¡œë”© */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ccc;
            font-size: 16px;
        }

        /* ëª¨ë°”ì¼ ëŒ€ì‘ */
        @media (max-width: 768px) {
            .sidebar.icon-panel-open {
                width: 40px;
            }
            
            .sidebar.icon-panel-open.thumbnails-open {
                width: 250px; /* í´ë”ì™€ ë™ì¼í•œ í¬ê¸°ë¡œ ê³ ì • */
            }

            .sidebar.icon-panel-open.folder-open {
                width: 250px; /* 40px (ì•„ì´ì½˜) + 210px (í´ë”) */
            }

            .sidebar.icon-panel-open.thumbnails-open.folder-open {
                width: 250px; /* ê³ ì • í¬ê¸° ìœ ì§€ */
            }
            
            .icon-panel {
                width: 40px;
                z-index: 200;
                pointer-events: auto;
            }
            
            .icon-btn {
                width: 32px;
                height: 32px;
                font-size: 16px;
                pointer-events: auto;
            }
            
            .thumbnails-section {
                width: 210px;
                padding-top: 8px;
            }

            .folder-section {
                width: 210px;
                padding: 6px;
            }

            .folder-title {
                font-size: 12px;
            }

            .folder-select-btn {
                font-size: 10px;
                padding: 3px 6px;
            }

            .toolbar {
                padding: 8px 12px;
                gap: 10px;
                height: 63px;
            }
            
            .toolbar-section {
                gap: 6px;
            }
            
            .toolbar-section.left {
                flex: 0.6;
            }
            
            .toolbar-section.center {
                flex: 1.8;
            }
            
            .toolbar-section.right {
                flex: 0.4;
            }
            
            .file-title {
                max-width: 180px;
                font-size: 12px;
            }

            .toolbar-btn, .fit-toggle-btn {
                width: 32px;
                height: 32px;
                font-size: 14px;
                padding: 6px;
            }

            #propertiesBtn {
                font-size: 18px;
            }

            .toolbar-divider {
                font-size: 12px;
            }

            .zoom-select {
                min-width: 55px;
                font-size: 12px;
                padding: 4px 8px;
            }

            .toolbar-input {
                min-width: 30px;
                font-size: 12px;
                padding: 4px 8px;
            }

            .properties-dialog {
                min-width: 300px;
                max-width: 90vw;
                padding: 20px;
            }

            .property-group {
                padding-bottom: 10px;
                margin-bottom: 10px;
            }

            .property-item {
                padding: 1px 0;
            }

            .property-label {
                min-width: 100px;
                font-size: 12px;
            }

            .property-value {
                font-size: 12px;
            }

            .properties-close-btn {
                border-radius: 18px;
                padding: 6px 16px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <!-- ìƒë‹¨ íˆ´ë°” -->
    <div class="toolbar" id="toolbar" style="display: none;">
        <div class="toolbar-section left">
            <button class="toolbar-btn" id="sidebarToggle" title="ì‚¬ì´ë“œë°” ì—´ê¸°/ë‹«ê¸° (Ctrl+B)">â˜°</button>
            <span class="file-title" id="fileTitle">PDF íŒŒì¼</span>
        </div>

        <div class="toolbar-section center">
            <input type="number" class="toolbar-input" id="pageInput" min="1" value="1">
            <span class="page-divider">/ <span id="totalPages">1</span></span>
            <div class="toolbar-divider">|</div>
            <button class="toolbar-btn" id="zoomOut" title="ì¶•ì†Œ (Ctrl+-)">-</button>
            <select class="zoom-select" id="zoomSelect">
                <!-- ì˜µì…˜ë“¤ì€ JavaScriptì—ì„œ ë™ì ìœ¼ë¡œ ìƒì„± -->
            </select>
            <button class="toolbar-btn" id="zoomIn" title="í™•ëŒ€ (Ctrl++)">+</button>
            <div class="toolbar-divider">|</div>
            <button class="toolbar-btn fit-toggle-btn" id="fitToggleBtn" title="í˜ì´ì§€ ë§ì¶¤ / ë„ˆë¹„ ë§ì¶¤ ì „í™˜">â†•ï¸</button>
            <button class="toolbar-btn" id="captureBtn" title="ì˜ì—­ ìº¡ì³ (Ctrl+Shift+X)">âœ‚ï¸</button>
        </div>

        <div class="toolbar-section right">
            <button class="toolbar-btn" id="themeToggleBtn" title="ë‹¤í¬ëª¨ë“œ">ğŸŒ™</button>
            <button class="toolbar-btn" id="propertiesBtn" title="ë¬¸ì„œ ì†ì„± (Ctrl+I)">â‹®</button>
        </div>
    </div>

    <!-- ë©”ì¸ ë ˆì´ì•„ì›ƒ -->
    <div class="main-layout">
        <!-- ì‚¬ì´ë“œë°” -->
        <div class="sidebar" id="sidebar">
            <!-- ì•„ì´ì½˜ íŒ¨ë„ -->
            <div class="icon-panel">
                <button class="icon-btn" id="folderBtn" title="í´ë” íƒìƒ‰ê¸°">ğŸ“</button>
                <button class="icon-btn" id="thumbnailsBtn" title="í˜ì´ì§€ ì¸ë„¤ì¼" disabled>ğŸ–¼ï¸</button>
            </div>
            
            <!-- ì¸ë„¤ì¼ ì„¹ì…˜ -->
            <div class="thumbnails-section">
                <div class="thumbnails-container" id="thumbnailsContainer">
                    <div class="loading-thumbnails" id="loadingThumbnails">
                        PDFë¥¼ ë¡œë“œí•´ì£¼ì„¸ìš”
                    </div>
                </div>
            </div>

            <!-- í´ë” íƒìƒ‰ê¸° ì„¹ì…˜ -->
            <div class="folder-section">
                <div class="folder-header">
                    <span class="folder-title" id="folderTitle">ğŸ“ í´ë” íƒìƒ‰ê¸°</span>
                    <button class="folder-select-btn" id="selectFolderBtn">í´ë” ì„ íƒ</button>
                </div>
                <div class="folder-tree" id="folderTree">
                    <div class="folder-empty" id="folderEmptyArea">ğŸ“ í´ë”ë¥¼ ì„ íƒí•˜ê±°ë‚˜ PDF íŒŒì¼ë“¤ì„ ì—¬ê¸°ë¡œ ë“œë˜ê·¸í•˜ì„¸ìš”</div>
                </div>
            </div>
        </div>

        <!-- ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ -->
        <div class="main-content" id="mainContent">
            <!-- íŒŒì¼ ì…ë ¥ ìš”ì†Œë“¤ (uploadArea ë°–ìœ¼ë¡œ ì´ë™) -->
            <input type="file" class="file-input" id="fileInput" accept=".pdf">
            <input type="file" class="file-input" id="folderInput" webkitdirectory directory multiple>
            
            <!-- ì—…ë¡œë“œ ì˜ì—­ -->
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">ğŸ“</div>
                <div class="upload-text">í´ë”ë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
                <button class="upload-btn">í´ë” ì„ íƒ</button>
                <div style="margin-top: 20px; text-align: center; color: #888; font-size: 14px; line-height: 1.6;">
                    <strong style="color: #ccc;">ì‚¬ìš©ë²•:</strong><br>
                    <strong style="color: #4285f4;">â€¢ í´ë” ì„ íƒ:</strong> <strong>í´ë” ì„ íƒ ë²„íŠ¼</strong>ìœ¼ë¡œ í´ë” ì„ íƒ (ëª¨ë“  í´ë” êµ¬ì¡° í‘œì‹œ, PDF íŒŒì¼ë§Œ ì—´ê¸° ê°€ëŠ¥)<br>
                    <strong style="color: #4285f4;">â€¢ í´ë” íƒìƒ‰ê¸°:</strong> <strong>ğŸ“ ì•„ì´ì½˜</strong>ìœ¼ë¡œ ì„ íƒëœ í´ë”ì˜ ëª¨ë“  í´ë”ì™€ PDF íŒŒì¼ë“¤ ê´€ë¦¬<br>
                    <strong style="color: #4285f4;">â€¢ í˜ì´ì§€ ì¸ë„¤ì¼:</strong> <strong>ğŸ–¼ï¸ ì•„ì´ì½˜</strong>ìœ¼ë¡œ í˜ì´ì§€ ì¸ë„¤ì¼ ë³´ê¸° ë° ë¹ ë¥¸ ì´ë™<br>
                    <strong style="color: #4285f4;">â€¢ ë¬¸ì„œ ì†ì„±:</strong> <strong>â‹® ë²„íŠ¼</strong> ë˜ëŠ” <strong>Ctrl+I</strong>ë¡œ ë¬¸ì„œ ì •ë³´ í™•ì¸<br>
                    <strong style="color: #4285f4;">â€¢ í…Œë§ˆ ë³€ê²½:</strong> <strong>ğŸŒ™ ë²„íŠ¼</strong>ìœ¼ë¡œ ë‹¤í¬ëª¨ë“œ/ë¼ì´íŠ¸ëª¨ë“œ/ì‹œìŠ¤í…œ ì„¤ì • ìˆœí™˜<br>
                    <strong style="color: #4285f4;">â€¢ ìŠ¤ë§ˆíŠ¸ ë³µì‚¬:</strong> <strong>Ctrl+C</strong>ë¡œ í…ìŠ¤íŠ¸ ì„ íƒ ì‹œ í…ìŠ¤íŠ¸ ë³µì‚¬, ë¯¸ì„ íƒ ì‹œ ì´ë¯¸ì§€ ë³µì‚¬<br>
                    <strong style="color: #4285f4;">â€¢ ì˜ì—­ ìº¡ì³:</strong> <strong>âœ‚ï¸ ë²„íŠ¼</strong> ë˜ëŠ” <strong>Ctrl+Shift+X</strong>ë¡œ ì›í•˜ëŠ” ì˜ì—­ì„ ë“œë˜ê·¸í•˜ì—¬ ì„ íƒ í›„ í´ë¦½ë³´ë“œ ë³µì‚¬<br>
                    <strong style="color: #4285f4;">â€¢ ì‚¬ì´ë“œë°” í† ê¸€:</strong> <strong>â˜° ë²„íŠ¼</strong> ë˜ëŠ” <strong>Ctrl+B</strong>ë¡œ ì‚¬ì´ë“œë°” ì—´ê¸°/ë‹«ê¸°<br>
                    <strong style="color: #4285f4;">â€¢ ìŠ¤ë§ˆíŠ¸ ì „ì²´ ì„ íƒ:</strong> <strong>Ctrl+A</strong>ë¡œ í˜ì´ì§€ ì…ë ¥ í•„ë“œ í¬ì»¤ìŠ¤ ì‹œ í•´ë‹¹ í•„ë“œë§Œ, ê·¸ ì™¸ì—” PDF í…ìŠ¤íŠ¸ ì „ì²´ ì„ íƒ<br>
                    <strong style="color: #4285f4;">â€¢ í…ìŠ¤íŠ¸ ì„ íƒ:</strong> PDF ë‚´ í…ìŠ¤íŠ¸ë¥¼ ë§ˆìš°ìŠ¤ë¡œ ë“œë˜ê·¸í•´ì„œ ì„ íƒ ê°€ëŠ¥<br>
                    <strong style="color: #4285f4;">â€¢ ë§ˆìš°ìŠ¤ ì¤‘ì‹¬ í™•ëŒ€:</strong> Ctrl+íœ ë¡œ ë§ˆìš°ìŠ¤ ì»¤ì„œ ì¤‘ì‹¬ í™•ëŒ€/ì¶•ì†Œ<br>
                    <strong style="color: #4285f4;">â€¢ í˜ì´ì§€ ë„¤ë¹„ê²Œì´ì…˜:</strong> í™”ì‚´í‘œ í‚¤ë¡œ í˜ì´ì§€ ì´ë™<br>
                    <strong style="color: #4285f4;">â€¢ ë§ì¶¤ ëª¨ë“œ:</strong> â†•ï¸/â†”ï¸ ë²„íŠ¼ìœ¼ë¡œ í˜ì´ì§€ ë§ì¶¤ê³¼ ë„ˆë¹„ ë§ì¶¤ í† ê¸€<br>
                    <strong style="color: #4285f4;">â€¢ ESC í‚¤:</strong> ìº¡ì³ ëª¨ë“œ ì¢…ë£Œ ë˜ëŠ” ì‚¬ì´ë“œë°” ë‹«ê¸°<br>
                    <strong style="color: #4285f4;">â€¢ ìµœì í™” ë Œë”ë§:</strong> ì„±ëŠ¥ê³¼ í’ˆì§ˆì˜ ê· í˜•ì¡íŒ í‘œì‹œ
                </div>
            </div>

            <!-- í´ë” ì„ íƒ ì™„ë£Œ ë©”ì‹œì§€ -->
            <div class="folder-selected-message" id="folderSelectedMessage" style="display: none;">
                <div class="folder-selected-icon">ğŸ“‚</div>
                <div class="folder-selected-text">í´ë”ê°€ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤!</div>
                <div class="folder-selected-subtitle">
                    ì™¼ìª½ í´ë” íƒìƒ‰ê¸°ì—ì„œ PDF íŒŒì¼ì„ í´ë¦­í•˜ì—¬ ì—´ì–´ë³´ì„¸ìš”.<br>
                    ğŸ“ í´ë” ì•„ì´ì½˜ì„ í´ë¦­í•˜ë©´ í´ë” íƒìƒ‰ê¸°ë¥¼ ì—´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </div>
            </div>

            <!-- PDF ë·°ì–´ -->
            <div class="pdf-viewer" id="pdfViewer">
                <div class="pdf-container" id="pdfContainer">
                    <div class="pdf-wrapper" id="pdfWrapper">
                        <div class="pdf-content" id="pdfContent">
                            <img id="pdfImage" alt="PDF Page">
                            <canvas id="pdfCanvas"></canvas>
                            <div class="text-layer" id="textLayer"></div>
                            <div class="capture-overlay" id="captureOverlay">
                                <div class="capture-guide" id="captureGuide">ë“œë˜ê·¸í•˜ì—¬ ìº¡ì³í•  ì˜ì—­ì„ ì„ íƒí•˜ì„¸ìš” (ESC: ì¢…ë£Œ)</div>
                                <div class="selection-area" id="selectionArea"></div>
                            </div>
                        </div>
                    </div>
                    <div class="loading" id="loading" style="display: none;">ë¡œë”©ì¤‘...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ë¬¸ì„œ ì†ì„± ëª¨ë‹¬ -->
    <div class="properties-modal" id="propertiesModal">
        <div class="properties-dialog">
            <div class="properties-header">
                <h2 class="properties-title">ë¬¸ì„œ ì†ì„±</h2>
            </div>
            <div class="properties-content" id="propertiesContent">
                <!-- ì†ì„±ë“¤ì´ ë™ì ìœ¼ë¡œ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </div>
            <div class="properties-footer">
                <button class="properties-close-btn" id="propertiesCloseBtnFooter">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <!-- í† ìŠ¤íŠ¸ ì•Œë¦¼ ì»¨í…Œì´ë„ˆ -->
    <div class="toast-container" id="toastContainer">
    </div>

    <script>
        // PDF.js ì›Œì»¤ ì„¤ì •
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        class PDFClipboard {
            constructor() {
                this.pdf = null;
                this.currentPage = 1;
                this.totalPages = 0;
                this.scale = 1.0;
                this.fitMode = 'none'; // 'width', 'page', 'none'
                this.currentFile = null; // í˜„ì¬ íŒŒì¼ ê°ì²´ ì €ì¥
                
                // ì„±ëŠ¥ ìµœì í™”ëœ ë Œë”ë§ ì„¤ì •
                this.pixelRatio = window.devicePixelRatio || 1;
                this.renderScale = 3.0; // ê³ í’ˆì§ˆ ë Œë”ë§ ìŠ¤ì¼€ì¼
                
                // ì›ë³¸ í˜ì´ì§€ í¬ê¸° ì €ì¥ (ì¤‘ìš”!)
                this.originalPageWidth = 0;
                this.originalPageHeight = 0;
                
                // ë Œë”ë§ ì‘ì—… ê´€ë¦¬
                this.currentRenderTask = null;
                
                // ë””ë°”ìš´ìŠ¤ íƒ€ì´ë¨¸ë“¤
                this.textLayerTimeout = null;
                this.isZooming = false;
                
                // ìº¡ì³ ê¸°ëŠ¥ ê´€ë ¨
                this.isCaptureMode = false;
                this.isSelecting = false;
                this.selectionStart = { x: 0, y: 0 };
                this.selectionEnd = { x: 0, y: 0 };
                
                // ì‚¬ì´ë“œë°” ê´€ë ¨
                this.isIconPanelOpen = false;
                this.isThumbnailsOpen = false;
                this.isFolderOpen = false;
                this.currentSidebarType = 'thumbnails'; // 'thumbnails' or 'folder'
                this.lastOpenedSidebarType = 'folder'; // ë§ˆì§€ë§‰ì— ì—´ë ¤ìˆë˜ íƒ­ ê¸°ì–µ
                this.thumbnails = [];
                this.folderStructure = null;
                this.currentFolder = null;
                this.selectedFile = null;
                this.currentFolderName = null; // í´ë”ëª… ì €ì¥
                
                this.initElements();
                this.initializeZoomSelect();
                this.bindEvents();
                
                // ì´ˆê¸° í…Œë§ˆ ì„¤ì •
                this.initializeTheme();
                
                // ì´ˆê¸° ìƒíƒœì—ì„œ ì¸ë„¤ì¼ ë²„íŠ¼ ë¹„í™œì„±í™”
                this.thumbnailsBtn.disabled = true;
            }

            initializeZoomSelect() {
                const defaultOptions = [25, 50, 75, 100, 125, 150, 200, 300, 400, 500];
                this.zoomSelect.innerHTML = '';
                
                defaultOptions.forEach(zoom => {
                    const option = document.createElement('option');
                    option.value = zoom;
                    option.textContent = zoom + '%';
                    if (zoom === 100) {
                        option.selected = true;
                    }
                    this.zoomSelect.appendChild(option);
                });
                
                // ì´ˆê¸° ë°°ìœ¨ ì„ íƒ ë°•ìŠ¤ í¬ê¸° ì„¤ì •
                this.updateZoomSelectWidth();
            }

            initElements() {
                this.uploadArea = document.getElementById('uploadArea');
                this.fileInput = document.getElementById('fileInput');
                this.toolbar = document.getElementById('toolbar');
                this.pdfViewer = document.getElementById('pdfViewer');
                this.pdfContainer = document.getElementById('pdfContainer');
                this.pdfWrapper = document.getElementById('pdfWrapper');
                this.pdfContent = document.getElementById('pdfContent');
                this.pdfImage = document.getElementById('pdfImage'); // ì´ë¯¸ì§€ ìš”ì†Œ
                this.canvas = document.getElementById('pdfCanvas'); // ìˆ¨ê²¨ì§„ ìº”ë²„ìŠ¤ (ë Œë”ë§ìš©)
                this.ctx = this.canvas.getContext('2d');
                this.textLayer = document.getElementById('textLayer');
                this.pageInput = document.getElementById('pageInput');
                this.totalPagesSpan = document.getElementById('totalPages');
                this.zoomIn = document.getElementById('zoomIn');
                this.zoomOut = document.getElementById('zoomOut');
                this.zoomSelect = document.getElementById('zoomSelect');
                this.fitToggleBtn = document.getElementById('fitToggleBtn');
                this.captureBtn = document.getElementById('captureBtn');
                this.sidebarToggle = document.getElementById('sidebarToggle');
                this.fileTitle = document.getElementById('fileTitle');
                this.toastContainer = document.getElementById('toastContainer');
                this.loading = document.getElementById('loading');
                this.folderSelectedMessage = document.getElementById('folderSelectedMessage');
                
                // ìƒˆë¡œìš´ UI ìš”ì†Œë“¤
                this.mainContent = document.getElementById('mainContent');
                this.sidebar = document.getElementById('sidebar');
                this.thumbnailsBtn = document.getElementById('thumbnailsBtn');
                this.folderBtn = document.getElementById('folderBtn');
                this.thumbnailsContainer = document.getElementById('thumbnailsContainer');
                this.loadingThumbnails = document.getElementById('loadingThumbnails');
                this.folderInput = document.getElementById('folderInput');
                this.selectFolderBtn = document.getElementById('selectFolderBtn');
                this.folderTree = document.getElementById('folderTree');
                this.folderTitle = document.getElementById('folderTitle'); // í´ë” ì œëª© ìš”ì†Œ ì¶”ê°€
                
                // ìº¡ì³ ê´€ë ¨ ìš”ì†Œë“¤
                this.captureOverlay = document.getElementById('captureOverlay');
                this.captureGuide = document.getElementById('captureGuide');
                this.selectionArea = document.getElementById('selectionArea');
                
                // ë¬¸ì„œ ì†ì„± ê´€ë ¨ ìš”ì†Œë“¤
                this.propertiesBtn = document.getElementById('propertiesBtn');
                this.propertiesModal = document.getElementById('propertiesModal');
                this.propertiesCloseBtnFooter = document.getElementById('propertiesCloseBtnFooter');
                this.propertiesContent = document.getElementById('propertiesContent');
                
                // í…Œë§ˆ í† ê¸€ ê´€ë ¨ ìš”ì†Œë“¤
                this.themeToggleBtn = document.getElementById('themeToggleBtn');
                this.currentTheme = 'dark'; // 'dark', 'light', 'system'
            }

            bindEvents() {
                // í´ë” ì—…ë¡œë“œ (ê¸°ë³¸ ë™ì‘ì„ í´ë” ì„ íƒìœ¼ë¡œ ë³€ê²½)
                this.uploadArea.addEventListener('click', () => this.folderInput.click());
                this.fileInput.addEventListener('change', (e) => this.handleFile(e.target.files[0]));
                
                // ë“œë˜ê·¸ ì•¤ ë“œë¡­
                this.uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    this.uploadArea.classList.add('dragover');
                });
                
                this.uploadArea.addEventListener('dragleave', () => {
                    this.uploadArea.classList.remove('dragover');
                });
                
                this.uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    this.uploadArea.classList.remove('dragover');
                    const files = Array.from(e.dataTransfer.files);
                    
                    // PDF íŒŒì¼ë§Œ í•„í„°ë§
                    const pdfFiles = files.filter(file => file.type === 'application/pdf');
                    
                    if (pdfFiles.length === 0 && files.length > 0) {
                        this.showToastMessage('ğŸ“ PDF íŒŒì¼ì´ í¬í•¨ëœ í´ë”ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”');
                        return;
                    } else if (pdfFiles.length === 0) {
                        this.showToastMessage('âŒ íŒŒì¼ì„ ì¸ì‹í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                        return;
                    }
                    
                    if (pdfFiles.length === 1) {
                        // ë‹¨ì¼ PDF íŒŒì¼ì´ë©´ ë°”ë¡œ ì—´ê¸°
                        this.handleFile(pdfFiles[0]);
                    } else {
                        // ì—¬ëŸ¬ PDF íŒŒì¼ì´ë©´ í´ë” êµ¬ì¡°ë¡œ ë§Œë“¤ì–´ì„œ í´ë” íƒìƒ‰ê¸°ì— í‘œì‹œ
                        this.buildFolderStructureFromDroppedFiles(pdfFiles);
                        
                        // í´ë” ì„ íƒ ì™„ë£Œ ë©”ì‹œì§€ í‘œì‹œ
                        this.showFolderSelectedMessage();
                        
                        // ì•„ì´ì½˜ íŒ¨ë„ì´ ì•ˆ ì—´ë ¤ìˆìœ¼ë©´ ì—´ê¸°
                        if (!this.isIconPanelOpen) {
                            this.toggleIconPanel();
                            // ì• ë‹ˆë©”ì´ì…˜ ì‹œê°„ì„ ê¸°ë‹¤ë¦° í›„ í´ë” íƒ­ ì—´ê¸°
                            setTimeout(() => {
                                this.openFolder();
                                this.renderFolderTree();
                            }, 200);
                        } else {
                            // ì´ë¯¸ ì—´ë ¤ìˆìœ¼ë©´ ë°”ë¡œ í´ë” íƒ­ ì—´ê¸°
                            this.openFolder();
                            this.renderFolderTree();
                        }
                        
                        this.showToastMessage(`âœ… ${pdfFiles.length}ê°œì˜ PDF íŒŒì¼ì„ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤`);
                    }
                });

                // ìƒˆë¡œìš´ UI ì´ë²¤íŠ¸ë“¤
                this.sidebarToggle.addEventListener('click', () => {
                    this.toggleIconPanel();
                });
                this.thumbnailsBtn.addEventListener('click', () => {
                    this.toggleThumbnails();
                });
                this.folderBtn.addEventListener('click', () => {
                    this.toggleFolder();
                });
                this.selectFolderBtn.addEventListener('click', (e) => {
                    this.openFolderDialog(e);
                });
                this.folderInput.addEventListener('change', (e) => {
                    this.handleFolderSelect(e);
                });
                
                // í…Œë§ˆ í† ê¸€ ì´ë²¤íŠ¸
                this.themeToggleBtn.addEventListener('click', () => {
                    this.toggleTheme();
                });
                
                // ì‹œìŠ¤í…œ í…Œë§ˆ ë³€ê²½ ê°ì§€
                if (window.matchMedia) {
                    const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
                    mediaQuery.addEventListener('change', () => {
                        if (this.currentTheme === 'system') {
                            this.applySystemTheme();
                        }
                    });
                }
                
                // ë¬¸ì„œ ì†ì„± ì´ë²¤íŠ¸ë“¤
                this.propertiesBtn.addEventListener('click', () => {
                    this.showDocumentProperties();
                });
                this.propertiesCloseBtnFooter.addEventListener('click', () => {
                    this.hideDocumentProperties();
                });
                this.propertiesModal.addEventListener('click', (e) => {
                    if (e.target === this.propertiesModal) {
                        this.hideDocumentProperties();
                    }
                });
                
                // ì´ˆê¸° ë¹ˆ ì˜ì—­ í´ë¦­ ì´ë²¤íŠ¸
                const initialEmptyArea = document.getElementById('folderEmptyArea');
                if (initialEmptyArea) {
                    initialEmptyArea.addEventListener('click', (e) => {
                        this.openFolderDialog(e);
                    });
                    
                    // ì´ˆê¸° ë¹ˆ ì˜ì—­ ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë²¤íŠ¸
                    initialEmptyArea.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        initialEmptyArea.classList.add('dragover');
                    });
                    
                    initialEmptyArea.addEventListener('dragleave', () => {
                        initialEmptyArea.classList.remove('dragover');
                    });
                    
                    initialEmptyArea.addEventListener('drop', (e) => {
                        e.preventDefault();
                        initialEmptyArea.classList.remove('dragover');
                        
                        const files = Array.from(e.dataTransfer.files);
                        const pdfFiles = files.filter(file => file.type === 'application/pdf');
                        
                        if (pdfFiles.length > 0) {
                            this.buildFolderStructureFromDroppedFiles(pdfFiles);
                            this.renderFolderTree();
                            this.showToastMessage(`âœ… ${pdfFiles.length}ê°œì˜ PDF íŒŒì¼ì„ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤`);
                        } else {
                            this.showToastMessage('âŒ PDF íŒŒì¼ë§Œ ë“œë¡­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤');
                        }
                    });
                }

                // ì¤Œ ì»¨íŠ¸ë¡¤
                this.zoomIn.addEventListener('click', () => {
                    if (!this.zoomIn.classList.contains('disabled')) {
                        this.zoomPage(1.25);
                    }
                });
                this.zoomOut.addEventListener('click', () => {
                    if (!this.zoomOut.classList.contains('disabled')) {
                        this.zoomPage(0.8);
                    }
                });
                this.zoomSelect.addEventListener('change', () => this.setZoomFromSelect());

                // ë§ì¶¤ í† ê¸€ ë²„íŠ¼
                this.fitToggleBtn.addEventListener('click', () => this.toggleFit());

                // ìº¡ì³ ë²„íŠ¼
                this.captureBtn.addEventListener('click', () => this.toggleCaptureMode());

                // í˜ì´ì§€ ì…ë ¥
                this.pageInput.addEventListener('change', () => this.goToPage());
                this.pageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.goToPage();
                });

                // í‚¤ë³´ë“œ ì´ë²¤íŠ¸
                document.addEventListener('keydown', (e) => this.handleKeyboard(e));

                // ë§ˆìš°ìŠ¤ íœ  ì´ë²¤íŠ¸
                this.pdfContainer.addEventListener('wheel', (e) => this.handleWheel(e));

                // ìœˆë„ìš° ë¦¬ì‚¬ì´ì¦ˆ
                window.addEventListener('resize', () => this.handleResize());
                
                // ìº¡ì³ ì˜¤ë²„ë ˆì´ ì´ë²¤íŠ¸
                this.captureOverlay.addEventListener('mousedown', (e) => this.startSelection(e));
                this.captureOverlay.addEventListener('mousemove', (e) => this.updateSelection(e));
                this.captureOverlay.addEventListener('mouseup', (e) => this.endSelection(e));
                this.captureOverlay.addEventListener('mouseleave', (e) => this.cancelSelection(e));
            }

            // ì´ˆê¸° í…Œë§ˆ ì„¤ì •
            initializeTheme() {
                // ê¸°ë³¸ì ìœ¼ë¡œ ì‹œìŠ¤í…œ ì„¤ì •ìœ¼ë¡œ ì‹œì‘
                this.currentTheme = 'system';
                this.themeToggleBtn.textContent = 'âš™ï¸';
                this.themeToggleBtn.title = 'ì‹œìŠ¤í…œ ì„¤ì •';
                this.applySystemTheme();
            }

            // í…Œë§ˆ í† ê¸€ ê¸°ëŠ¥
            toggleTheme() {
                switch (this.currentTheme) {
                    case 'dark':
                        this.currentTheme = 'light';
                        this.themeToggleBtn.textContent = 'â˜€ï¸';
                        this.themeToggleBtn.title = 'ë¼ì´íŠ¸ëª¨ë“œ';
                        document.body.classList.add('light-theme');
                        break;
                    case 'light':
                        this.currentTheme = 'system';
                        this.themeToggleBtn.textContent = 'âš™ï¸';
                        this.themeToggleBtn.title = 'ì‹œìŠ¤í…œ ì„¤ì •';
                        this.applySystemTheme();
                        break;
                    case 'system':
                        this.currentTheme = 'dark';
                        this.themeToggleBtn.textContent = 'ğŸŒ™';
                        this.themeToggleBtn.title = 'ë‹¤í¬ëª¨ë“œ';
                        document.body.classList.remove('light-theme');
                        break;
                }
            }

            // ì‹œìŠ¤í…œ í…Œë§ˆ ì ìš©
            applySystemTheme() {
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    // ì‹œìŠ¤í…œì´ ë‹¤í¬ëª¨ë“œ
                    document.body.classList.remove('light-theme');
                } else {
                    // ì‹œìŠ¤í…œì´ ë¼ì´íŠ¸ëª¨ë“œ
                    document.body.classList.add('light-theme');
                }
            }

            // ë¬¸ì„œ ì†ì„± í‘œì‹œ
            async showDocumentProperties() {
                if (!this.pdf || !this.currentFile) {
                    this.showToastMessage('âŒ PDF íŒŒì¼ì´ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
                    return;
                }

                try {
                    // PDF ë©”íƒ€ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                    const metadata = await this.pdf.getMetadata();
                    const info = metadata.info;
                    
                    // ì²« ë²ˆì§¸ í˜ì´ì§€ì—ì„œ í¬ê¸° ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                    const firstPage = await this.pdf.getPage(1);
                    const viewport = firstPage.getViewport({scale: 1.0});
                    
                    // íŒŒì¼ í¬ê¸° í¬ë§·íŒ…
                    const fileSize = this.formatFileSize(this.currentFile.size);
                    
                    // í˜ì´ì§€ í¬ê¸° ê³„ì‚° (72 DPI ê¸°ì¤€ìœ¼ë¡œ mm ë³€í™˜)
                    const widthMm = Math.round(viewport.width * 25.4 / 72);
                    const heightMm = Math.round(viewport.height * 25.4 / 72);
                    const orientation = viewport.width > viewport.height ? 'ê°€ë¡œ ëª¨ë“œ' : 'ì„¸ë¡œ ëª¨ë“œ';
                    
                    // ë‚ ì§œ í¬ë§·íŒ… ê°œì„ 
                    const formatDate = (dateStr) => {
                        if (!dateStr) return '-';
                        
                        try {
                            let date;
                            
                            // PDF í‘œì¤€ ë‚ ì§œ í˜•ì‹ ì²˜ë¦¬ (D:YYYYMMDDHHmmSSOHH'mm')
                            if (typeof dateStr === 'string' && dateStr.startsWith('D:')) {
                                const cleanDate = dateStr.substring(2); // D: ì œê±°
                                const year = cleanDate.substring(0, 4);
                                const month = cleanDate.substring(4, 6);
                                const day = cleanDate.substring(6, 8);
                                const hour = cleanDate.substring(8, 10) || '00';
                                const minute = cleanDate.substring(10, 12) || '00';
                                const second = cleanDate.substring(12, 14) || '00';
                                
                                // ISO í˜•ì‹ìœ¼ë¡œ ë³€í™˜
                                const isoString = `${year}-${month}-${day}T${hour}:${minute}:${second}`;
                                date = new Date(isoString);
                            } else {
                                // ì¼ë°˜ ë‚ ì§œ ë¬¸ìì—´ ì²˜ë¦¬
                                date = new Date(dateStr);
                            }
                            
                            if (isNaN(date.getTime())) return '-';
                            
                            return date.toLocaleString('ko-KR', {
                                year: '2-digit',
                                month: 'numeric',
                                day: 'numeric',
                                weekday: 'short',
                                hour: 'numeric',
                                minute: 'numeric',
                                second: 'numeric',
                                hour12: false
                            }).replace(/\./g, '. ');
                        } catch (e) {
                            console.log('ë‚ ì§œ íŒŒì‹± ì˜¤ë¥˜:', e, 'ì›ë³¸:', dateStr);
                            return '-';
                        }
                    };

                    // ì†ì„± ë°ì´í„° êµ¬ì„±
                    const properties = [
                        {
                            group: 'ê¸°ë³¸ ì •ë³´',
                            items: [
                                { label: 'íŒŒì¼ ì´ë¦„:', value: this.currentFile.name },
                                { label: 'íŒŒì¼ í¬ê¸°:', value: fileSize }
                            ]
                        },
                        {
                            group: '',
                            items: [
                                { label: 'ì§ì±…:', value: info.Title || this.currentFile.name.replace('.pdf', '') },
                                { label: 'ì‘ì„±ì:', value: info.Author || '-' },
                                { label: 'ì œëª©:', value: info.Subject || '-' },
                                { label: 'í‚¤ì›Œë“œ:', value: info.Keywords || '-' },
                                { label: 'ìƒì„±ë¨:', value: formatDate(info.CreationDate) },
                                { label: 'ìˆ˜ì •:', value: formatDate(info.ModDate) },
                                { label: 'ì• í”Œë¦¬ì¼€ì´ì…˜:', value: info.Creator || '-' }
                            ]
                        },
                        {
                            group: '',
                            items: [
                                { label: 'PDF ë³€í™˜ í”„ë¡œê·¸ë¨:', value: info.Producer || '-' },
                                { label: 'PDF ë²„ì „:', value: metadata.metadata?.get('pdf:PDFVersion') || '1.7' },
                                { label: 'í˜ì´ì§€ ìˆ˜:', value: this.totalPages.toString() },
                                { label: 'í˜ì´ì§€ í¬ê¸°:', value: `${widthMm}Ã—${heightMm}mm(${orientation})` }
                            ]
                        },
                        {
                            group: '',
                            items: [
                                { label: 'ë¹ ë¥¸ ì›¹ ë³´ê¸°:', value: 'ì•„ë‹ˆìš”' }
                            ]
                        }
                    ];

                    // HTML ìƒì„±
                    this.propertiesContent.innerHTML = '';
                    
                    properties.forEach(group => {
                        const groupDiv = document.createElement('div');
                        groupDiv.className = 'property-group';
                        
                        group.items.forEach(item => {
                            const itemDiv = document.createElement('div');
                            itemDiv.className = 'property-item';
                            
                            const labelDiv = document.createElement('div');
                            labelDiv.className = 'property-label';
                            labelDiv.textContent = item.label;
                            
                            const valueDiv = document.createElement('div');
                            valueDiv.className = 'property-value';
                            valueDiv.textContent = item.value;
                            
                            itemDiv.appendChild(labelDiv);
                            itemDiv.appendChild(valueDiv);
                            groupDiv.appendChild(itemDiv);
                        });
                        
                        this.propertiesContent.appendChild(groupDiv);
                    });

                    // ëª¨ë‹¬ í‘œì‹œ (ì• ë‹ˆë©”ì´ì…˜ê³¼ í•¨ê»˜)
                    this.propertiesModal.style.display = 'flex';
                    // ë¸Œë¼ìš°ì €ê°€ ë Œë”ë§ì„ ì™„ë£Œí•œ í›„ show í´ë˜ìŠ¤ ì¶”ê°€
                    setTimeout(() => {
                        this.propertiesModal.classList.add('show');
                    }, 10);
                    
                } catch (error) {
                    console.error('ë¬¸ì„œ ì†ì„± ë¡œë“œ ì‹¤íŒ¨:', error);
                    this.showToastMessage('âŒ ë¬¸ì„œ ì†ì„±ì„ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
                }
            }

            // ë¬¸ì„œ ì†ì„± ìˆ¨ê¸°ê¸° (ì• ë‹ˆë©”ì´ì…˜ê³¼ í•¨ê»˜)
            hideDocumentProperties() {
                this.propertiesModal.classList.remove('show');
                // ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ í›„ display none
                setTimeout(() => {
                    if (!this.propertiesModal.classList.contains('show')) {
                        this.propertiesModal.style.display = 'none';
                    }
                }, 300);
            }

            // íŒŒì¼ í¬ê¸° í¬ë§·íŒ…
            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                
                return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + sizes[i];
            }

            // í´ë” ì„ íƒ ë‹¤ì´ì–¼ë¡œê·¸ ì—´ê¸° ë©”ì„œë“œ ì¶”ê°€
            openFolderDialog() {
                console.log('í´ë” ì„ íƒ ë‹¤ì´ì–¼ë¡œê·¸ ì—´ê¸°');
                this.folderInput.click();
            }

            async handleFile(file) {
                if (!file || file.type !== 'application/pdf') {
                    alert('PDF íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤!');
                    return;
                }

                this.loading.style.display = 'block';
                this.currentFile = file; // í˜„ì¬ íŒŒì¼ ì €ì¥
                
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    this.pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
                    this.totalPages = this.pdf.numPages;
                    this.currentPage = 1;
                    
                    // íŒŒì¼ ì œëª© ì—…ë°ì´íŠ¸
                    this.fileTitle.textContent = file.name;
                    
                    // ë¸Œë¼ìš°ì € íƒ­ ì œëª©ë„ íŒŒì¼ëª…ìœ¼ë¡œ ì—…ë°ì´íŠ¸
                    document.title = file.name;
                    
                    this.showPDFViewer();
                    
                    // ë¨¼ì € ê¸°ë³¸ ìŠ¤ì¼€ì¼ë¡œ ë Œë”ë§ (ì›ë³¸ í¬ê¸° ì •ë³´ íšë“)
                    await this.renderPage();
                    
                    // ì¸ë„¤ì¼ ìƒì„± ì‹œì‘
                    this.generateThumbnails();
                    
                    // ì›ë³¸ í¬ê¸° ì •ë³´ë¥¼ ì–»ì€ í›„ì— í˜ì´ì§€ ë§ì¶¤ ì ìš©
                    if (this.originalPageWidth && this.originalPageHeight) {
                        this.fitMode = 'page';
                        const page = await this.pdf.getPage(this.currentPage);
                        await this.calculateFitToPage(page);
                        
                        // í˜ì´ì§€ ë§ì¶¤ ìŠ¤ì¼€ì¼ë¡œ ë‹¤ì‹œ ë Œë”ë§
                        await this.renderPage();
                    }
                    
                    this.updateUI();
                    this.updateFitToggle();
                    
                    // PDF ë¡œë“œ ì™„ë£Œ ì‹œ ì¸ë„¤ì¼ ë²„íŠ¼ í™œì„±í™”
                    this.thumbnailsBtn.disabled = false;
                    
                } catch (error) {
                    alert('PDF íŒŒì¼ì„ ë¡œë“œí•˜ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    console.error(error);
                } finally {
                    this.loading.style.display = 'none';
                }
            }

            showFolderSelectedMessage() {
                this.uploadArea.style.display = 'none';
                this.folderSelectedMessage.style.display = 'flex';
                this.toolbar.style.display = 'none';
                this.pdfViewer.style.display = 'none';
                
                // ì œëª©ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ë˜ëŒë¦¬ê¸°
                document.title = 'PDF Viewer';
            }

            showPDFViewer() {
                this.uploadArea.style.display = 'none';
                this.folderSelectedMessage.style.display = 'none';
                this.toolbar.style.display = 'flex';
                this.pdfViewer.style.display = 'flex';
                
                // PDF ë·°ì–´ê°€ ì—´ë¦´ ë•Œ ì¸ë„¤ì¼ ë²„íŠ¼ í™œì„±í™” í™•ì¸
                if (this.pdf) {
                    this.thumbnailsBtn.disabled = false;
                }
            }

            // í–„ë²„ê±° ë²„íŠ¼ - ì•„ì´ì½˜ íŒ¨ë„ í† ê¸€
            toggleIconPanel() {
                // ìº¡ì³ ëª¨ë“œê°€ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ ì¢…ë£Œ
                if (this.isCaptureMode) {
                    this.exitCaptureMode();
                }
                
                this.isIconPanelOpen = !this.isIconPanelOpen;
                
                if (this.isIconPanelOpen) {
                    this.sidebar.classList.add('icon-panel-open');
                    // ë§ˆì§€ë§‰ì— ì—´ë ¤ìˆë˜ íƒ­ìœ¼ë¡œ ë³µì›
                    setTimeout(() => {
                        if (!this.isThumbnailsOpen && !this.isFolderOpen) {
                            if (this.lastOpenedSidebarType === 'thumbnails') {
                                this.openThumbnails();
                                // ì¸ë„¤ì¼ì¸ ê²½ìš° í˜„ì¬ í˜ì´ì§€ ì„ íƒ ìƒíƒœ ì—…ë°ì´íŠ¸
                                setTimeout(() => {
                                    this.updateThumbnailSelection();
                                }, 100);
                            } else {
                                this.openFolder();
                            }
                        }
                    }, 150); // ì•„ì´ì½˜ íŒ¨ë„ ì• ë‹ˆë©”ì´ì…˜ í›„ íƒ­ ë³µì›
                } else {
                    this.sidebar.classList.remove('icon-panel-open');
                    // í˜„ì¬ ì—´ë ¤ìˆëŠ” íƒ­ì„ ê¸°ì–µ
                    if (this.isThumbnailsOpen) {
                        this.lastOpenedSidebarType = 'thumbnails';
                    } else if (this.isFolderOpen) {
                        this.lastOpenedSidebarType = 'folder';
                    }
                    // ì•„ì´ì½˜ íŒ¨ë„ì´ ë‹«íˆë©´ ëª¨ë“  ì„¹ì…˜ë„ ë‹«ê¸°
                    this.closeThumbnails();
                    this.closeFolder();
                }
                
                // ì‚¬ì´ë“œë°” ë³€í™”ì— ë”°ë¥¸ ë°°ìœ¨ ì¬ì¡°ì •
                setTimeout(() => {
                    this.adjustScaleForSidebarChange();
                }, 350); // ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ í›„ ì¡°ì •
            }

            // ì¸ë„¤ì¼ í† ê¸€
            toggleThumbnails() {
                // ì¸ë„¤ì¼ ë²„íŠ¼ì´ ë¹„í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ ë™ì‘í•˜ì§€ ì•ŠìŒ
                if (this.thumbnailsBtn.disabled) {
                    return;
                }
                
                if (!this.isIconPanelOpen) {
                    this.toggleIconPanel(); // ì•„ì´ì½˜ íŒ¨ë„ì´ ë‹«í˜€ìˆìœ¼ë©´ ë¨¼ì € ì—´ê¸°
                    return;
                }
                
                // ì¸ë„¤ì¼ì´ ì´ë¯¸ ì—´ë ¤ìˆìœ¼ë©´ ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•ŠìŒ
                if (this.isThumbnailsOpen) {
                    return;
                }
                
                // ë‹¤ë¥¸ ì„¹ì…˜ì´ ì—´ë ¤ìˆìœ¼ë©´ ë‹«ê¸°
                if (this.isFolderOpen) {
                    this.closeFolder();
                }
                
                // ì¸ë„¤ì¼ ì—´ê¸°
                this.openThumbnails();
                // ì¸ë„¤ì¼ì„ ì—´ ë•Œ í˜„ì¬ í˜ì´ì§€ ì„ íƒ ìƒíƒœ ì—…ë°ì´íŠ¸
                setTimeout(() => {
                    this.updateThumbnailSelection();
                }, 100); // ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ í›„ ì—…ë°ì´íŠ¸
                
                // ì¸ë„¤ì¼ í† ê¸€ì— ë”°ë¥¸ ë°°ìœ¨ ì¬ì¡°ì •
                setTimeout(() => {
                    this.adjustScaleForSidebarChange();
                }, 350); // ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ í›„ ì¡°ì •
            }

            // í´ë” íƒìƒ‰ê¸° í† ê¸€
            toggleFolder() {
                if (!this.isIconPanelOpen) {
                    this.toggleIconPanel(); // ì•„ì´ì½˜ íŒ¨ë„ì´ ë‹«í˜€ìˆìœ¼ë©´ ë¨¼ì € ì—´ê¸°
                    return;
                }
                
                // í´ë”ê°€ ì´ë¯¸ ì—´ë ¤ìˆìœ¼ë©´ ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•ŠìŒ
                if (this.isFolderOpen) {
                    return;
                }
                
                // ë‹¤ë¥¸ ì„¹ì…˜ì´ ì—´ë ¤ìˆìœ¼ë©´ ë‹«ê¸°
                if (this.isThumbnailsOpen) {
                    this.closeThumbnails();
                }
                
                // í´ë” íƒìƒ‰ê¸° ì—´ê¸°
                this.openFolder();
                
                // í´ë” í† ê¸€ì— ë”°ë¥¸ ë°°ìœ¨ ì¬ì¡°ì •
                setTimeout(() => {
                    this.adjustScaleForSidebarChange();
                }, 350); // ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ í›„ ì¡°ì •
            }

            // í´ë” íƒìƒ‰ê¸° ì—´ê¸°
            openFolder() {
                this.isFolderOpen = true;
                this.currentSidebarType = 'folder';
                this.sidebar.classList.add('folder-open');
                this.folderBtn.classList.add('active');
                this.lastOpenedSidebarType = 'folder'; // ë§ˆì§€ë§‰ ì—´ë¦° íƒ­ ì—…ë°ì´íŠ¸
            }

            // í´ë” íƒìƒ‰ê¸° ë‹«ê¸°
            closeFolder() {
                this.isFolderOpen = false;
                this.sidebar.classList.remove('folder-open');
                this.folderBtn.classList.remove('active');
            }

            // í´ë” ì„ íƒ ë‹¤ì´ì–¼ë¡œê·¸ ì—´ê¸° ë©”ì„œë“œ ì¶”ê°€
            openFolderDialog(event) {
                console.log('í´ë” ì„ íƒ ë‹¤ì´ì–¼ë¡œê·¸ ì—´ê¸°');
                // ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€
                if (event) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                this.folderInput.click();
            }

            // í´ë” ì„ íƒ ì²˜ë¦¬
            async handleFolderSelect(event) {
                const files = Array.from(event.target.files);
                if (files.length === 0) return;

                console.log('ì„ íƒëœ íŒŒì¼ë“¤:', files.length);
                
                // í´ë”ëª… ì¶”ì¶œ (ì²« ë²ˆì§¸ íŒŒì¼ì˜ ê²½ë¡œì—ì„œ)
                const firstFile = files[0];
                const pathParts = firstFile.webkitRelativePath.split('/');
                const folderName = pathParts[0]; // ì²« ë²ˆì§¸ ë¶€ë¶„ì´ í´ë”ëª…
                this.currentFolderName = folderName;

                // í´ë” ì œëª© ì—…ë°ì´íŠ¸
                this.updateFolderTitle(folderName);

                // í´ë” êµ¬ì¡° ìƒì„± (ëª¨ë“  íŒŒì¼ê³¼ í´ë” í¬í•¨)
                this.buildFolderStructure(files);
                
                // PDF íŒŒì¼ ê°œìˆ˜ í™•ì¸
                const pdfFiles = files.filter(file => file.type === 'application/pdf');
                
                // í´ë” ì„ íƒ ì™„ë£Œ ë©”ì‹œì§€ í‘œì‹œ
                this.showFolderSelectedMessage();
                
                // ì•„ì´ì½˜ íŒ¨ë„ì´ ì•ˆ ì—´ë ¤ìˆìœ¼ë©´ ì—´ê¸°
                if (!this.isIconPanelOpen) {
                    this.toggleIconPanel();
                    // ì• ë‹ˆë©”ì´ì…˜ ì‹œê°„ì„ ê¸°ë‹¤ë¦° í›„ í´ë” íƒ­ ì—´ê¸°
                    setTimeout(() => {
                        this.openFolder();
                        this.renderFolderTree();
                    }, 200);
                } else {
                    // ì´ë¯¸ ì—´ë ¤ìˆìœ¼ë©´ ë°”ë¡œ í´ë” íƒ­ ì—´ê¸°
                    this.openFolder();
                    this.renderFolderTree();
                }
                
                if (pdfFiles.length > 0) {
                    this.showToastMessage(`âœ… ${pdfFiles.length}ê°œì˜ PDF íŒŒì¼ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤`);
                } else {
                    this.showToastMessage('ğŸ“ í´ë” êµ¬ì¡°ë¥¼ ë¡œë“œí–ˆìŠµë‹ˆë‹¤ (PDF íŒŒì¼ ì—†ìŒ)');
                }
            }

            // í´ë” ì œëª© ì—…ë°ì´íŠ¸ ë©”ì„œë“œ ì¶”ê°€
            updateFolderTitle(folderName) {
                if (folderName) {
                    this.folderTitle.textContent = `ğŸ“ ${folderName}`;
                } else {
                    this.folderTitle.textContent = 'ğŸ“ í´ë” íƒìƒ‰ê¸°';
                }
            }

            // í´ë” êµ¬ì¡° ìƒì„± - ëª¨ë“  í´ë” í‘œì‹œ, PDF íŒŒì¼ë§Œ í•„í„°ë§
            buildFolderStructure(files) {
                const structure = {
                    name: this.currentFolderName || 'ì„ íƒëœ í´ë”',
                    type: 'folder',
                    children: {},
                    files: [],
                    expanded: true
                };

                console.log('í´ë” êµ¬ì¡° ìƒì„± ì‹œì‘, íŒŒì¼ ê°œìˆ˜:', files.length);

                // ë¨¼ì € ëª¨ë“  í´ë” êµ¬ì¡°ë¥¼ ìƒì„±
                const folderSet = new Set();
                
                files.forEach(file => {
                    const pathParts = file.webkitRelativePath.split('/');
                    
                    // í´ë” ê²½ë¡œë“¤ì„ ìˆ˜ì§‘ (íŒŒì¼ëª… ì œì™¸)
                    for (let i = 1; i < pathParts.length - 1; i++) {
                        const folderPath = pathParts.slice(0, i + 1).join('/');
                        folderSet.add(folderPath);
                    }
                });

                // í´ë” êµ¬ì¡° ìƒì„±
                folderSet.forEach(folderPath => {
                    const pathParts = folderPath.split('/');
                    let current = structure;

                    for (let i = 1; i < pathParts.length; i++) {
                        const folderName = pathParts[i];
                        
                        if (!current.children[folderName]) {
                            current.children[folderName] = {
                                name: folderName,
                                type: 'folder',
                                children: {},
                                files: [],
                                expanded: false
                            };
                            console.log(`  ìƒˆ í´ë” ìƒì„±: "${folderName}"`);
                        }
                        current = current.children[folderName];
                    }
                });

                // ì´ì œ PDF íŒŒì¼ë“¤ë§Œ ì¶”ê°€
                files.forEach(file => {
                    // PDF íŒŒì¼ë§Œ ì²˜ë¦¬
                    if (file.type !== 'application/pdf') {
                        return;
                    }

                    const pathParts = file.webkitRelativePath.split('/');
                    let current = structure;

                    // í´ë” ê²½ë¡œ ë”°ë¼ê°€ê¸° (íŒŒì¼ëª… ì œì™¸)
                    for (let i = 1; i < pathParts.length - 1; i++) {
                        const folderName = pathParts[i];
                        current = current.children[folderName];
                    }

                    // PDF íŒŒì¼ ì¶”ê°€
                    const fileName = pathParts[pathParts.length - 1];
                    console.log(`  PDF íŒŒì¼ "${fileName}"ì„ í˜„ì¬ ìœ„ì¹˜ì— ì¶”ê°€`);
                    
                    current.files.push({
                        name: fileName,
                        type: 'file',
                        file: file,
                        path: file.webkitRelativePath
                    });
                });

                this.folderStructure = structure;
                console.log('ìµœì¢… í´ë” êµ¬ì¡°:', structure);
            }

            // ë“œë¡­ëœ íŒŒì¼ë“¤ë¡œ í´ë” êµ¬ì¡° ìƒì„±
            buildFolderStructureFromDroppedFiles(files) {
                const structure = {
                    name: 'ë“œë¡­ëœ íŒŒì¼ë“¤',
                    type: 'folder',
                    children: {},
                    files: [],
                    expanded: true
                };

                files.forEach(file => {
                    // ë“œë¡­ëœ íŒŒì¼ë“¤ì€ ê²½ë¡œê°€ ì—†ìœ¼ë¯€ë¡œ ë£¨íŠ¸ì— ì§ì ‘ ì¶”ê°€
                    structure.files.push({
                        name: file.name,
                        type: 'file',
                        file: file,
                        path: file.name
                    });
                });

                this.folderStructure = structure;
                this.currentFolderName = 'ë“œë¡­ëœ íŒŒì¼ë“¤';
                this.updateFolderTitle(this.currentFolderName);
            }

            // í´ë” íŠ¸ë¦¬ ë Œë”ë§ - ë£¨íŠ¸ í´ë”ëŠ” í‘œì‹œí•˜ì§€ ì•Šê³  ë‚´ìš©ë§Œ ë Œë”ë§
            renderFolderTree() {
                if (!this.folderStructure) {
                    this.folderTree.innerHTML = '<div class="folder-empty" id="folderEmptyArea">ğŸ“ í´ë”ë¥¼ ì„ íƒí•˜ê±°ë‚˜ PDF íŒŒì¼ë“¤ì„ ì—¬ê¸°ë¡œ ë“œë˜ê·¸í•˜ì„¸ìš”</div>';
                    
                    // ë¹ˆ ì˜ì—­ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
                    const emptyArea = document.getElementById('folderEmptyArea');
                    if (emptyArea) {
                        emptyArea.addEventListener('click', (e) => {
                            this.openFolderDialog(e);
                        });
                        
                        // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë²¤íŠ¸ ì¶”ê°€
                        emptyArea.addEventListener('dragover', (e) => {
                            e.preventDefault();
                            emptyArea.classList.add('dragover');
                        });
                        
                        emptyArea.addEventListener('dragleave', () => {
                            emptyArea.classList.remove('dragover');
                        });
                        
                        emptyArea.addEventListener('drop', (e) => {
                            e.preventDefault();
                            emptyArea.classList.remove('dragover');
                            
                            const files = Array.from(e.dataTransfer.files);
                            const pdfFiles = files.filter(file => file.type === 'application/pdf');
                            
                            if (pdfFiles.length > 0) {
                                // ê°€ìƒì˜ í´ë” êµ¬ì¡° ìƒì„± (ë“œë¡­ëœ íŒŒì¼ë“¤ë¡œ)
                                this.buildFolderStructureFromDroppedFiles(pdfFiles);
                                this.renderFolderTree();
                                this.showToastMessage(`âœ… ${pdfFiles.length}ê°œì˜ PDF íŒŒì¼ì„ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤`);
                            } else {
                                this.showToastMessage('âŒ PDF íŒŒì¼ë§Œ ë“œë¡­í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤');
                            }
                        });
                    }
                    return;
                }

                this.folderTree.innerHTML = '';
                
                // ë£¨íŠ¸ í´ë”ì˜ ë‚´ìš©ë§Œ ë Œë”ë§ (ë£¨íŠ¸ í´ë” ìì²´ëŠ” í‘œì‹œí•˜ì§€ ì•ŠìŒ)
                this.renderFolderContents(this.folderStructure, this.folderTree, -1); // depthë¥¼ -1ë¡œ ì‹œì‘í•´ì„œ ì‹¤ì œ ë‚´ìš©ì´ 0ë¶€í„° ì‹œì‘ë˜ë„ë¡
            }

            // í´ë” ë‚´ìš© ë Œë”ë§ (ë£¨íŠ¸ í´ë” ìì²´ëŠ” ë Œë”ë§í•˜ì§€ ì•Šê³  ë‚´ìš©ë§Œ)
            renderFolderContents(node, container, depth) {
                // í•˜ìœ„ í´ë”ë“¤ ë¨¼ì € ë Œë”ë§
                Object.values(node.children)
                    .sort((a, b) => a.name.localeCompare(b.name))
                    .forEach(child => {
                        this.renderFolderNode(child, container, depth + 1);
                    });

                // ê·¸ ë‹¤ìŒ íŒŒì¼ë“¤ ë Œë”ë§
                node.files
                    .sort((a, b) => a.name.localeCompare(b.name))
                    .forEach(fileNode => {
                        this.renderFileNode(fileNode, container, depth + 1);
                    });
            }

            // í´ë” ë…¸ë“œ ë Œë”ë§
            renderFolderNode(node, container, depth) {
                if (node.type === 'folder') {
                    // í´ë” ì•„ì´í…œ ìƒì„±
                    const folderItem = document.createElement('div');
                    folderItem.className = 'folder-item';
                    folderItem.style.paddingLeft = (depth * 16 + 4) + 'px';

                    // ëª¨ë“  í´ë”ë¥¼ ìƒí˜¸ì‘ìš© ê°€ëŠ¥í•˜ê²Œ ë§Œë“¤ê¸°
                    folderItem.innerHTML = `
                        <span class="folder-icon expandable" data-action="toggle">
                            ${node.expanded ? 'ğŸ“‚' : 'ğŸ“'}
                        </span>
                        <span class="folder-name">${node.name}</span>
                    `;

                    // ëª¨ë“  í´ë”ì— í´ë¦­ ì´ë²¤íŠ¸ (ì—´ê¸°/ë‹«ê¸°)
                    folderItem.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        // ëª¨ë“  í´ë” í† ê¸€ ê°€ëŠ¥
                        node.expanded = !node.expanded;
                        this.renderFolderTree();
                    });

                    container.appendChild(folderItem);

                    // í™•ì¥ëœ í´ë”ì˜ ìì‹ë“¤ ë Œë”ë§ (ìì‹ì´ ìˆì„ ë•Œë§Œ)
                    if (node.expanded) {
                        const hasSubfolders = Object.keys(node.children).length > 0;
                        const hasPdfFiles = node.files.length > 0;
                        
                        if (hasSubfolders || hasPdfFiles) {
                            // í•˜ìœ„ í´ë”ë“¤ ë¨¼ì €
                            Object.values(node.children)
                                .sort((a, b) => a.name.localeCompare(b.name))
                                .forEach(child => {
                                    this.renderFolderNode(child, container, depth + 1);
                                });

                            // ê·¸ ë‹¤ìŒ íŒŒì¼ë“¤ (PDFë§Œ)
                            node.files
                                .sort((a, b) => a.name.localeCompare(b.name))
                                .forEach(fileNode => {
                                    this.renderFileNode(fileNode, container, depth + 1);
                                });
                        } else {
                            // ë¹ˆ í´ë” í‘œì‹œ
                            const emptyItem = document.createElement('div');
                            emptyItem.className = 'folder-item';
                            emptyItem.style.paddingLeft = ((depth + 1) * 16 + 4) + 'px';
                            emptyItem.style.color = '#888';
                            emptyItem.innerHTML = `
                                <span class="folder-icon">ğŸ“­</span>
                                <span class="folder-name">(ë¹ˆ í´ë”)</span>
                            `;
                            container.appendChild(emptyItem);
                        }
                    }
                }
            }

            // íŒŒì¼ ë…¸ë“œ ë Œë”ë§
            renderFileNode(fileNode, container, depth) {
                const fileItem = document.createElement('div');
                fileItem.className = 'folder-item pdf-file';
                fileItem.style.paddingLeft = (depth * 16 + 4) + 'px';
                fileItem.dataset.filePath = fileNode.path;

                fileItem.innerHTML = `
                    <span class="folder-icon">ğŸ“„</span>
                    <span class="folder-name" title="${fileNode.name}">${fileNode.name}</span>
                `;

                // íŒŒì¼ ì „ì²´ ë¼ì¸ì— í´ë¦­ ì´ë²¤íŠ¸
                fileItem.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    this.selectFileInTree(fileItem);
                    this.handleFile(fileNode.file);
                    
                    // ë¸Œë¼ìš°ì € íƒ­ ì œëª©ë„ íŒŒì¼ëª…ìœ¼ë¡œ ì—…ë°ì´íŠ¸
                    document.title = fileNode.name;
                });

                container.appendChild(fileItem);
            }

            // íŠ¸ë¦¬ì—ì„œ íŒŒì¼ ì„ íƒ
            selectFileInTree(fileItem) {
                // ê¸°ì¡´ ì„ íƒ í•´ì œ
                const previousSelected = this.folderTree.querySelector('.folder-item.selected');
                if (previousSelected) {
                    previousSelected.classList.remove('selected');
                }

                // ìƒˆë¡œìš´ íŒŒì¼ ì„ íƒ
                fileItem.classList.add('selected');
                this.selectedFile = fileItem.dataset.filePath;
            }

            // ì¸ë„¤ì¼ ì—´ê¸°
            openThumbnails() {
                this.isThumbnailsOpen = true;
                this.sidebar.classList.add('thumbnails-open');
                this.thumbnailsBtn.classList.add('active');
                this.lastOpenedSidebarType = 'thumbnails'; // ë§ˆì§€ë§‰ ì—´ë¦° íƒ­ ì—…ë°ì´íŠ¸
            }

            // ì¸ë„¤ì¼ ë‹«ê¸°
            closeThumbnails() {
                this.isThumbnailsOpen = false;
                this.sidebar.classList.remove('thumbnails-open');
                this.thumbnailsBtn.classList.remove('active');
            }

            // ì‚¬ì´ë“œë°” ë³€í™”ì— ë”°ë¥¸ ë°°ìœ¨ ì¬ì¡°ì •
            async adjustScaleForSidebarChange() {
                if (!this.pdf || this.fitMode === 'none') return;
                
                this.startZooming();
                
                try {
                    const page = await this.pdf.getPage(this.currentPage);
                    let newScale;
                    
                    if (this.fitMode === 'width') {
                        newScale = await this.calculateFitToWidthScale(page);
                    } else if (this.fitMode === 'page') {
                        newScale = await this.calculateFitToPageScale(page);
                    } else {
                        return;
                    }
                    
                    // ìŠ¤ì¼€ì¼ ì—…ë°ì´íŠ¸ (ë¶€ë“œëŸ¬ìš´ ì „í™˜ ì—†ì´)
                    this.scale = newScale;
                    this.updateUI();
                    this.updateImageSize();
                    this.updateScrollAreaForZoom(); // í˜ì´ì§€ ë§ì¶¤ ëª¨ë“œì—ì„œ ìŠ¤í¬ë¡¤ ë°©ì§€ ì ìš©
                    this.scheduleTextLayerUpdate();
                    
                } catch (error) {
                    console.error('ë°°ìœ¨ ì¬ì¡°ì • ì‹¤íŒ¨:', error);
                } finally {
                    this.isZooming = false;
                }
            }

            // ... (ì´í•˜ ê¸°ì¡´ ë©”ì„œë“œë“¤ ë™ì¼í•˜ê²Œ ìœ ì§€)
            async renderPage(renderTextLayer = true) {
                if (!this.pdf) return;

                // ì´ì „ ë Œë”ë§ ì‘ì—… ì·¨ì†Œ
                await this.cancelCurrentRender();

                const page = await this.pdf.getPage(this.currentPage);
                
                // ê¸°ì¡´ í…ìŠ¤íŠ¸ ë ˆì´ì–´ í´ë¦¬ì–´
                this.clearTextLayer();
                
                // ë§ì¶¤ ëª¨ë“œì— ë”°ë¥¸ ìŠ¤ì¼€ì¼ ê³„ì‚°
                if (this.fitMode === 'width') {
                    await this.calculateFitToWidth(page);
                } else if (this.fitMode === 'page') {
                    await this.calculateFitToPage(page);
                }
                
                const displayViewport = page.getViewport({scale: this.scale});
                
                // ì´ë¯¸ì§€ë¡œ ë Œë”ë§
                await this.renderAsImage(page, displayViewport);
                
                // ìŠ¤í¬ë¡¤ ì˜ì—­ ì—…ë°ì´íŠ¸
                this.updateScrollArea(displayViewport);
                
                // í…ìŠ¤íŠ¸ ë ˆì´ì–´ ë Œë”ë§
                if (renderTextLayer) {
                    this.scheduleTextLayerRender(page, displayViewport);
                }
            }

            async renderAsImage(page, displayViewport) {
                try {
                    // í˜„ì¬ í˜ì´ì§€ì˜ ì‹¤ì œ í¬ê¸° ì €ì¥ (scale 1.0 ê¸°ì¤€)
                    const originalViewport = page.getViewport({scale: 1.0});
                    this.originalPageWidth = originalViewport.width;
                    this.originalPageHeight = originalViewport.height;
                    
                    // ê³ í’ˆì§ˆ ë Œë”ë§ì„ ìœ„í•œ ìº”ë²„ìŠ¤ ì„¤ì •
                    const highQualityScale = this.scale * this.renderScale;
                    const highQualityViewport = page.getViewport({scale: highQualityScale});
                    
                    // ìˆ¨ê²¨ì§„ ìº”ë²„ìŠ¤ì— ê³ í’ˆì§ˆë¡œ ë Œë”ë§
                    this.canvas.width = highQualityViewport.width;
                    this.canvas.height = highQualityViewport.height;

                    // Canvas í´ë¦¬ì–´
                    this.ctx.setTransform(1, 0, 0, 1, 0, 0);
                    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

                    const renderContext = {
                        canvasContext: this.ctx,
                        viewport: highQualityViewport
                    };
                    
                    // ìƒˆë¡œìš´ ë Œë”ë§ ì‘ì—… ì‹œì‘
                    this.currentRenderTask = page.render(renderContext);
                    
                    // ë Œë”ë§ ì™„ë£Œ ëŒ€ê¸°
                    await this.currentRenderTask.promise;
                    
                    // Canvasë¥¼ ì´ë¯¸ì§€ë¡œ ë³€í™˜
                    const imageDataUrl = this.canvas.toDataURL('image/png', 1.0);
                    
                    // ì´ë¯¸ì§€ ìš”ì†Œì— ì„¤ì •
                    this.pdfImage.src = imageDataUrl;
                    this.pdfImage.style.width = displayViewport.width + 'px';
                    this.pdfImage.style.height = displayViewport.height + 'px';
                    
                    // í…ìŠ¤íŠ¸ ë ˆì´ì–´ í¬ê¸° ì„¤ì •
                    this.textLayer.style.width = displayViewport.width + 'px';
                    this.textLayer.style.height = displayViewport.height + 'px';
                    
                    // ë Œë”ë§ ì™„ë£Œ í›„ ì‘ì—… ì°¸ì¡° í•´ì œ
                    this.currentRenderTask = null;
                    
                } catch (error) {
                    // ì·¨ì†Œëœ ë Œë”ë§ì€ ì˜¤ë¥˜ê°€ ì•„ë‹˜
                    if (error.name === 'RenderingCancelledException') {
                        console.log('ë Œë”ë§ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    } else {
                        console.error('ë Œë”ë§ ì‹¤íŒ¨:', error);
                    }
                    this.currentRenderTask = null;
                }
            }

            updateScrollArea(viewport) {
                // PDF ë˜í¼ í¬ê¸°ë¥¼ PDF í¬ê¸° + ì—¬ë°±ìœ¼ë¡œ ì„¤ì •
                const pdfWidth = this.originalPageWidth * this.scale;
                const pdfHeight = this.originalPageHeight * this.scale;
                const margin = 20; // ìƒí•˜ì¢Œìš° 10pxì”© ì—¬ë°±ìœ¼ë¡œ ì¤„ì„
                
                // ì»¨í…Œì´ë„ˆë³´ë‹¤ ì‘ìœ¼ë©´ ì»¨í…Œì´ë„ˆ í¬ê¸°ì— ë§ì¶¤ (ì¤‘ì•™ ì •ë ¬)
                const containerWidth = this.pdfContainer.clientWidth;
                const containerHeight = this.pdfContainer.clientHeight;
                
                // í˜ì´ì§€ ë§ì¶¤ ëª¨ë“œì—ì„œëŠ” ìŠ¤í¬ë¡¤ì´ ìƒê¸°ì§€ ì•Šìœ¼ë©´ì„œë„ ìµœëŒ€í•œ í™”ë©´ì„ í™œìš©
                if (this.fitMode === 'page') {
                    // ë˜í¼ë¥¼ ì»¨í…Œì´ë„ˆë³´ë‹¤ ì‚´ì§ ì‘ê²Œ í•˜ì—¬ ìŠ¤í¬ë¡¤ ë°©ì§€, í•˜ì§€ë§Œ ì—¬ë°±ì€ ìµœì†Œí™”
                    this.pdfWrapper.style.width = (containerWidth - 2) + 'px'; // ìµœì†Œí•œì˜ ì—¬ìœ  ê³µê°„
                    this.pdfWrapper.style.height = (containerHeight - 2) + 'px'; // ìµœì†Œí•œì˜ ì—¬ìœ  ê³µê°„
                    this.pdfWrapper.style.justifyContent = 'center';
                    this.pdfWrapper.style.alignItems = 'center';
                } else {
                    // ë‹¤ë¥¸ ëª¨ë“œì—ì„œëŠ” ê¸°ì¡´ ë¡œì§ ì‚¬ìš©
                    const wrapperWidth = Math.max(pdfWidth + margin, containerWidth);
                    const wrapperHeight = Math.max(pdfHeight + margin, containerHeight);
                    
                    this.pdfWrapper.style.width = wrapperWidth + 'px';
                    this.pdfWrapper.style.height = wrapperHeight + 'px';
                    
                    // PDFê°€ ì»¨í…Œì´ë„ˆë³´ë‹¤ ì‘ìœ¼ë©´ ì¤‘ì•™ ì •ë ¬
                    if (pdfWidth < containerWidth) {
                        this.pdfWrapper.style.justifyContent = 'center';
                    } else {
                        this.pdfWrapper.style.justifyContent = 'flex-start';
                    }
                    
                    if (pdfHeight < containerHeight) {
                        this.pdfWrapper.style.alignItems = 'center';
                    } else {
                        this.pdfWrapper.style.alignItems = 'flex-start';
                    }
                }
            }

            async cancelCurrentRender() {
                // í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ë Œë”ë§ ì‘ì—…ì´ ìˆìœ¼ë©´ ì·¨ì†Œ
                if (this.currentRenderTask) {
                    try {
                        this.currentRenderTask.cancel();
                    } catch (error) {
                        console.log('ë Œë”ë§ ì·¨ì†Œ ì‹œë„:', error.message);
                    }
                    this.currentRenderTask = null;
                }
            }

            scheduleTextLayerRender(page, viewport) {
                // ê¸°ì¡´ í…ìŠ¤íŠ¸ ë ˆì´ì–´ ë Œë”ë§ íƒ€ì´ë¨¸ ì·¨ì†Œ
                if (this.textLayerTimeout) {
                    clearTimeout(this.textLayerTimeout);
                }
                
                // 100ms í›„ì— í…ìŠ¤íŠ¸ ë ˆì´ì–´ ë Œë”ë§
                this.textLayerTimeout = setTimeout(async () => {
                    if (!this.isZooming) {
                        await this.renderTextLayer(page, viewport);
                    }
                }, 100);
            }

            async clearTextLayer() {
                // ëª¨ë“  íƒ€ì´ë¨¸ ì·¨ì†Œ
                if (this.textLayerTimeout) {
                    clearTimeout(this.textLayerTimeout);
                    this.textLayerTimeout = null;
                }
                
                // ê¸°ì¡´ ì„ íƒ í•´ì œ
                if (window.getSelection) {
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                }
                
                // í…ìŠ¤íŠ¸ ë ˆì´ì–´ ì™„ì „íˆ í´ë¦¬ì–´
                const textLayer = this.textLayer;
                
                while (textLayer.hasChildNodes()) {
                    textLayer.removeChild(textLayer.firstChild);
                }
                
                textLayer.innerHTML = '';
                textLayer.textContent = '';
                textLayer.offsetHeight; // ê°•ì œ ë¦¬í”Œë¡œìš°
            }

            async renderTextLayer(page, viewport) {
                try {
                    // í…ìŠ¤íŠ¸ ì½˜í…ì¸  ê°€ì ¸ì˜¤ê¸°
                    const textContent = await page.getTextContent();
                    
                    if (!textContent || !textContent.items || textContent.items.length === 0) {
                        return;
                    }
                    
                    // í…ìŠ¤íŠ¸ ì•„ì´í…œë“¤ì„ Y ìœ„ì¹˜ë³„ë¡œ ê·¸ë£¹í™” (ë¼ì¸ë³„ë¡œ)
                    const lines = [];
                    
                    textContent.items.forEach((textItem) => {
                        if (!textItem.str || textItem.str.trim() === '') return;
                        
                        const transform = textItem.transform;
                        if (!transform || transform.length < 6) return;
                        
                        const y = transform[5];
                        const fontSize = textItem.height || Math.sqrt(transform[2] * transform[2] + transform[3] * transform[3]);
                        
                        // ê°™ì€ ë¼ì¸ìœ¼ë¡œ ê°„ì£¼í•  Y ìœ„ì¹˜ ë²”ìœ„
                        const tolerance = fontSize * 0.5;
                        
                        let foundLine = lines.find(line => Math.abs(line.y - y) < tolerance);
                        
                        if (!foundLine) {
                            foundLine = {
                                y: y,
                                fontSize: fontSize,
                                items: []
                            };
                            lines.push(foundLine);
                        }
                        
                        foundLine.items.push({
                            ...textItem,
                            x: transform[4],
                            y: y,
                            fontSize: fontSize
                        });
                    });
                    
                    // ê° ë¼ì¸ë³„ë¡œ ì²˜ë¦¬
                    lines.forEach(line => {
                        // X ìœ„ì¹˜ìˆœìœ¼ë¡œ ì •ë ¬
                        line.items.sort((a, b) => a.x - b.x);
                        
                        // ì—°ì†ëœ í…ìŠ¤íŠ¸ë“¤ì„ ê·¸ë£¹í™”
                        const groups = [];
                        let currentGroup = null;
                        
                        line.items.forEach((item, index) => {
                            if (!currentGroup) {
                                currentGroup = {
                                    x: item.x,
                                    y: item.y,
                                    fontSize: item.fontSize,
                                    text: item.str,
                                    width: item.width || item.str.length * item.fontSize * 0.6,
                                    transform: item.transform
                                };
                                groups.push(currentGroup);
                            } else {
                                const currentEnd = currentGroup.x + currentGroup.width;
                                const itemStart = item.x;
                                const gap = itemStart - currentEnd;
                                
                                // ê°„ê²©ì´ ì‘ìœ¼ë©´ í˜„ì¬ ê·¸ë£¹ì— ì¶”ê°€, í¬ë©´ ìƒˆ ê·¸ë£¹ ìƒì„±
                                if (gap < item.fontSize * 0.8) {
                                    // ê³µë°± ì¶”ê°€ ì—¬ë¶€ ê²°ì •
                                    if (gap > item.fontSize * 0.2) {
                                        currentGroup.text += ' ';
                                    }
                                    currentGroup.text += item.str;
                                    currentGroup.width = itemStart + (item.width || item.str.length * item.fontSize * 0.6) - currentGroup.x;
                                } else {
                                    // ìƒˆ ê·¸ë£¹ ì‹œì‘
                                    currentGroup = {
                                        x: item.x,
                                        y: item.y,
                                        fontSize: item.fontSize,
                                        text: item.str,
                                        width: item.width || item.str.length * item.fontSize * 0.6,
                                        transform: item.transform
                                    };
                                    groups.push(currentGroup);
                                }
                            }
                        });
                        
                        // ê° ê·¸ë£¹ë³„ë¡œ span ìƒì„±
                        groups.forEach(group => {
                            if (group.text.trim() === '') return;
                            
                            const span = document.createElement('span');
                            
                            // PDF ì¢Œí‘œë¥¼ í™”ë©´ ì¢Œí‘œë¡œ ë³€í™˜
                            const screenX = group.x * viewport.scale;
                            const screenY = (viewport.height / viewport.scale - group.y - group.fontSize) * viewport.scale;
                            
                            // ìŠ¤íƒ€ì¼ ì ìš©
                            span.style.position = 'absolute';
                            span.style.left = screenX + 'px';
                            span.style.top = screenY + 'px';
                            span.style.fontSize = (group.fontSize * viewport.scale) + 'px';
                            span.style.fontFamily = 'serif';
                            span.style.color = 'transparent';
                            span.style.cursor = 'text';
                            span.style.userSelect = 'text';
                            span.style.webkitUserSelect = 'text';
                            span.style.mozUserSelect = 'text';
                            span.style.pointerEvents = 'auto';
                            span.style.whiteSpace = 'pre';
                            span.style.transformOrigin = '0 0';
                            
                            // í…ìŠ¤íŠ¸ ë‚´ìš© ì„¤ì •
                            span.textContent = group.text;
                            
                            // íšŒì „ ì²˜ë¦¬
                            const transform = group.transform;
                            if (Math.abs(transform[1]) > 0.001 || Math.abs(transform[2]) > 0.001) {
                                const angle = Math.atan2(transform[1], transform[0]) * (180 / Math.PI);
                                span.style.transform = `rotate(${angle}deg)`;
                            }
                            
                            this.textLayer.appendChild(span);
                        });
                    });
                    
                } catch (error) {
                    console.error('í…ìŠ¤íŠ¸ ë ˆì´ì–´ ë Œë”ë§ ì‹¤íŒ¨:', error);
                }
            }

            async calculateFitToWidth(page) {
                const containerWidth = this.pdfContainer.clientWidth;
                
                // í˜„ì¬ í˜ì´ì§€ì˜ ì‹¤ì œ í¬ê¸° ê°€ì ¸ì˜¤ê¸°
                const viewport = page.getViewport({scale: 1.0});
                const pageWidth = viewport.width;
                
                const safeMargin = 80; // ìŠ¤í¬ë¡¤ë°” ë°©ì§€ë¥¼ ìœ„í•œ ì•ˆì „ ì—¬ë°±
                // ì›ë³¸ í¬ê¸° ì‚¬ìš©
                this.scale = (containerWidth - safeMargin) / pageWidth;
            }

            async calculateFitToPage(page) {
                const containerWidth = this.pdfContainer.clientWidth;
                const containerHeight = this.pdfContainer.clientHeight;
                
                // í˜„ì¬ í˜ì´ì§€ì˜ ì‹¤ì œ í¬ê¸° ê°€ì ¸ì˜¤ê¸°
                const viewport = page.getViewport({scale: 1.0});
                const pageWidth = viewport.width;
                const pageHeight = viewport.height;
                
                // í˜ì´ì§€ ë§ì¶¤ ëª¨ë“œì—ì„œëŠ” ìµœì†Œí•œì˜ ì—¬ë°±ë§Œ í™•ë³´í•˜ì—¬ í™”ë©´ì„ ìµœëŒ€í•œ í™œìš©
                const safeMargin = 20; // ìµœì†Œí•œì˜ ì—¬ë°±ìœ¼ë¡œ ì¤„ì„
                const scaleX = (containerWidth - safeMargin) / pageWidth;
                const scaleY = (containerHeight - safeMargin) / pageHeight;
                this.scale = Math.min(scaleX, scaleY);
            }

            async toggleFit() {
                this.startZooming();
                
                // í˜„ì¬ ëª¨ë“œì— ë”°ë¼ ë‹¤ìŒ ëª¨ë“œë¡œ ì „í™˜
                const newFitMode = this.fitMode === 'page' ? 'width' : 'page';
                
                // ë§ì¶¤ ëª¨ë“œë¥¼ ìœ„í•œ ìŠ¤ì¼€ì¼ ê³„ì‚°
                if (!this.pdf) return;
                const page = await this.pdf.getPage(this.currentPage);
                
                let newScale;
                if (newFitMode === 'width') {
                    newScale = await this.calculateFitToWidthScale(page);
                } else {
                    newScale = await this.calculateFitToPageScale(page);
                }
                
                await this.performZoom(newScale, newFitMode);
            }

            async calculateFitToWidthScale(page) {
                const containerWidth = this.pdfContainer.clientWidth;
                
                // í˜„ì¬ í˜ì´ì§€ì˜ ì‹¤ì œ í¬ê¸° ê°€ì ¸ì˜¤ê¸°
                const viewport = page.getViewport({scale: 1.0});
                const pageWidth = viewport.width;
                
                const safeMargin = 80; // ìŠ¤í¬ë¡¤ë°” ë°©ì§€ë¥¼ ìœ„í•œ ì•ˆì „ ì—¬ë°±
                return (containerWidth - safeMargin) / pageWidth;
            }

            async calculateFitToPageScale(page) {
                const containerWidth = this.pdfContainer.clientWidth;
                const containerHeight = this.pdfContainer.clientHeight;
                
                // í˜„ì¬ í˜ì´ì§€ì˜ ì‹¤ì œ í¬ê¸° ê°€ì ¸ì˜¤ê¸°
                const viewport = page.getViewport({scale: 1.0});
                const pageWidth = viewport.width;
                const pageHeight = viewport.height;
                
                const safeMargin = 20; // ìµœì†Œí•œì˜ ì—¬ë°±ìœ¼ë¡œ ì¤„ì„
                const scaleX = (containerWidth - safeMargin) / pageWidth;
                const scaleY = (containerHeight - safeMargin) / pageHeight;
                return Math.min(scaleX, scaleY);
            }

            updateFitToggle() {
                // í˜„ì¬ fitModeì— ë”°ë¼ ë²„íŠ¼ ì•„ì´ì½˜ê³¼ ìƒíƒœ ë³€ê²½
                if (this.fitMode === 'page') {
                    this.fitToggleBtn.textContent = 'â†”ï¸'; // í˜ì´ì§€ ë§ì¶¤ ìƒíƒœ, í´ë¦­í•˜ë©´ ë„ˆë¹„ ë§ì¶¤ìœ¼ë¡œ
                    this.fitToggleBtn.classList.add('active');
                    this.fitToggleBtn.title = 'ë„ˆë¹„ì— ë§ì¶¤ìœ¼ë¡œ ì „í™˜';
                    // í˜ì´ì§€ ë§ì¶¤ ëª¨ë“œì—ì„œëŠ” ìŠ¤í¬ë¡¤ ì™„ì „ ê¸ˆì§€
                    this.pdfContainer.classList.add('fit-page');
                } else if (this.fitMode === 'width') {
                    this.fitToggleBtn.textContent = 'â†•ï¸'; // ë„ˆë¹„ ë§ì¶¤ ìƒíƒœ, í´ë¦­í•˜ë©´ í˜ì´ì§€ ë§ì¶¤ìœ¼ë¡œ
                    this.fitToggleBtn.classList.add('active');
                    this.fitToggleBtn.title = 'í˜ì´ì§€ì— ë§ì¶¤ìœ¼ë¡œ ì „í™˜';
                    this.pdfContainer.classList.remove('fit-page');
                } else {
                    this.fitToggleBtn.textContent = 'â†•ï¸'; // ê¸°ë³¸ ìƒíƒœ, í´ë¦­í•˜ë©´ í˜ì´ì§€ ë§ì¶¤ìœ¼ë¡œ
                    this.fitToggleBtn.classList.remove('active');
                    this.fitToggleBtn.title = 'í˜ì´ì§€ì— ë§ì¶¤';
                    this.pdfContainer.classList.remove('fit-page');
                }
            }

            async setZoomFromSelect() {
                this.startZooming();
                
                const zoomPercent = parseInt(this.zoomSelect.value);
                const newScale = zoomPercent / 100;
                
                await this.performZoom(newScale, 'none');
            }

            async zoomPage(factor) {
                // í˜„ì¬ ìŠ¤ì¼€ì¼ì—ì„œ ìƒˆë¡œìš´ ìŠ¤ì¼€ì¼ ê³„ì‚°
                let newScale = this.scale * factor;
                const minScale = 0.25;
                const maxScale = 5.0;
                
                // ì œí•œ ë²”ìœ„ë¥¼ ë²—ì–´ë‚˜ë©´ ë™ì‘í•˜ì§€ ì•ŠìŒ
                if (newScale < minScale || newScale > maxScale) {
                    return;
                }
                
                this.startZooming();
                
                newScale = Math.max(minScale, Math.min(maxScale, newScale));
                
                await this.performZoom(newScale, 'none');
            }

            startZooming() {
                this.isZooming = true;
                this.clearTextLayer();
            }

            async performZoom(newScale, newFitMode) {
                // í˜„ì¬ ì»¨í…Œì´ë„ˆ ì¤‘ì•™ ì¢Œí‘œ ê³„ì‚°
                const container = this.pdfContainer;
                const containerCenterX = container.clientWidth / 2;
                const containerCenterY = container.clientHeight / 2;
                
                // í˜„ì¬ ìŠ¤í¬ë¡¤ ìœ„ì¹˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì¤‘ì•™ì ì˜ ë¬¸ì„œ ì¢Œí‘œ ê³„ì‚°
                const currentCenterX = container.scrollLeft + containerCenterX;
                const currentCenterY = container.scrollTop + containerCenterY;
                
                // ìŠ¤ì¼€ì¼ ë¹„ìœ¨ ê³„ì‚°
                const scaleRatio = newScale / this.scale;
                
                // ë‚´ë¶€ ìƒíƒœ ì—…ë°ì´íŠ¸
                const oldScale = this.scale;
                this.scale = newScale;
                if (newFitMode !== undefined) this.fitMode = newFitMode;
                this.updateFitToggle(); // CSS í´ë˜ìŠ¤ ì—…ë°ì´íŠ¸ í¬í•¨
                this.updateUI();
                
                // ì´ë¯¸ì§€ì™€ í…ìŠ¤íŠ¸ ë ˆì´ì–´ë¥¼ ìƒˆë¡œìš´ ìŠ¤ì¼€ì¼ë¡œ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
                this.updateImageSize();
                this.updateScrollAreaForZoom();
                
                // ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ì¡°ì • (ì¤‘ì•™ ê¸°ì¤€ ìœ ì§€)
                const newCenterX = currentCenterX * scaleRatio;
                const newCenterY = currentCenterY * scaleRatio;
                
                const newScrollLeft = newCenterX - containerCenterX;
                const newScrollTop = newCenterY - containerCenterY;
                
                // ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ì„¤ì • (ê²½ê³„ê°’ ì²´í¬)
                container.scrollLeft = Math.max(0, Math.min(newScrollLeft, container.scrollWidth - container.clientWidth));
                container.scrollTop = Math.max(0, Math.min(newScrollTop, container.scrollHeight - container.clientHeight));
                
                // í…ìŠ¤íŠ¸ ë ˆì´ì–´ ìŠ¤ì¼€ì¼ ì—…ë°ì´íŠ¸ (ë””ë°”ìš´ìŠ¤)
                this.scheduleTextLayerUpdate();
                
                // ì¤Œ ì™„ë£Œ
                this.isZooming = false;
            }

            updateImageSize() {
                if (!this.pdfImage.src || !this.originalPageWidth || !this.originalPageHeight) return;
                
                // ì›ë³¸ í¬ê¸° ê¸°ì¤€ìœ¼ë¡œ ìŠ¤ì¼€ì¼ëœ í¬ê¸° ê³„ì‚°
                const scaledWidth = this.originalPageWidth * this.scale;
                const scaledHeight = this.originalPageHeight * this.scale;
                
                // ì´ë¯¸ì§€ í¬ê¸° ì—…ë°ì´íŠ¸ (transform ì œê±°í•˜ê³  ì‹¤ì œ í¬ê¸°ë¡œ)
                this.pdfImage.style.transform = '';
                this.pdfImage.style.transformOrigin = '';
                this.pdfImage.style.width = scaledWidth + 'px';
                this.pdfImage.style.height = scaledHeight + 'px';
                
                // í…ìŠ¤íŠ¸ ë ˆì´ì–´ í¬ê¸° ì—…ë°ì´íŠ¸
                this.textLayer.style.transform = '';
                this.textLayer.style.transformOrigin = '';
                this.textLayer.style.width = scaledWidth + 'px';
                this.textLayer.style.height = scaledHeight + 'px';
            }
            
            updateScrollAreaForZoom() {
                if (!this.pdfImage.src || !this.originalPageWidth || !this.originalPageHeight) return;
                
                const scaledWidth = this.originalPageWidth * this.scale;
                const scaledHeight = this.originalPageHeight * this.scale;
                const margin = 40;
                
                const containerWidth = this.pdfContainer.clientWidth;
                const containerHeight = this.pdfContainer.clientHeight;
                
                // í˜ì´ì§€ ë§ì¶¤ ëª¨ë“œì—ì„œëŠ” ìŠ¤í¬ë¡¤ì´ ìƒê¸°ì§€ ì•Šìœ¼ë©´ì„œë„ ìµœëŒ€í•œ í™”ë©´ì„ í™œìš©
                if (this.fitMode === 'page') {
                    // ë˜í¼ë¥¼ ì»¨í…Œì´ë„ˆë³´ë‹¤ ì‚´ì§ ì‘ê²Œ í•˜ì—¬ ìŠ¤í¬ë¡¤ ë°©ì§€, í•˜ì§€ë§Œ ì—¬ë°±ì€ ìµœì†Œí™”
                    this.pdfWrapper.style.width = (containerWidth - 2) + 'px'; // ìµœì†Œí•œì˜ ì—¬ìœ  ê³µê°„
                    this.pdfWrapper.style.height = (containerHeight - 2) + 'px'; // ìµœì†Œí•œì˜ ì—¬ìœ  ê³µê°„
                    this.pdfWrapper.style.justifyContent = 'center';
                    this.pdfWrapper.style.alignItems = 'center';
                } else {
                    // ë‹¤ë¥¸ ëª¨ë“œì—ì„œëŠ” ê¸°ì¡´ ë¡œì§ ì‚¬ìš©
                    const wrapperWidth = Math.max(scaledWidth + margin, containerWidth);
                    const wrapperHeight = Math.max(scaledHeight + margin, containerHeight);
                    
                    this.pdfWrapper.style.width = wrapperWidth + 'px';
                    this.pdfWrapper.style.height = wrapperHeight + 'px';
                    
                    // ì¤‘ì•™ ì •ë ¬ ì„¤ì •
                    if (scaledWidth < containerWidth) {
                        this.pdfWrapper.style.justifyContent = 'center';
                    } else {
                        this.pdfWrapper.style.justifyContent = 'flex-start';
                    }
                    
                    if (scaledHeight < containerHeight) {
                        this.pdfWrapper.style.alignItems = 'center';
                    } else {
                        this.pdfWrapper.style.alignItems = 'flex-start';
                    }
                }
            }
            
            getCurrentPageViewport() {
                // ì €ì¥ëœ ì›ë³¸ í¬ê¸° ì‚¬ìš© (ê°€ì¥ ì •í™•í•¨)
                if (this.originalPageWidth && this.originalPageHeight) {
                    return { 
                        width: this.originalPageWidth, 
                        height: this.originalPageHeight 
                    };
                }
                
                // ë§ˆì§€ë§‰ ìˆ˜ë‹¨: ê¸°ë³¸ê°’ ë°˜í™˜
                return { width: 800, height: 600 };
            }
            
            scheduleTextLayerUpdate() {
                // ê¸°ì¡´ íƒ€ì´ë¨¸ ì·¨ì†Œ
                if (this.textLayerTimeout) {
                    clearTimeout(this.textLayerTimeout);
                }
                
                // 100ms í›„ì— í…ìŠ¤íŠ¸ ë ˆì´ì–´ë§Œ ì—…ë°ì´íŠ¸
                this.textLayerTimeout = setTimeout(async () => {
                    if (this.pdf) {
                        const page = await this.pdf.getPage(this.currentPage);
                        const displayViewport = page.getViewport({scale: this.scale});
                        await this.renderTextLayer(page, displayViewport);
                    }
                }, 100);
            }

            updateUI() {
                this.pageInput.value = this.currentPage;
                this.pageInput.max = this.totalPages;
                this.totalPagesSpan.textContent = this.totalPages;
                
                // í˜ì´ì§€ ì…ë ¥ ë°•ìŠ¤ í¬ê¸° ë™ì  ì¡°ì •
                this.updatePageInputWidth();
                
                const zoomPercent = Math.round(this.scale * 100);
                this.updateZoomSelect(zoomPercent);
                
                // ë°°ìœ¨ ì„ íƒ ë°•ìŠ¤ í¬ê¸° ë™ì  ì¡°ì •
                this.updateZoomSelectWidth();
                
                // í™•ëŒ€/ì¶•ì†Œ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
                this.updateZoomButtonStates();
                
                this.updateFitToggle();
            }
            
            updateZoomButtonStates() {
                // ìµœì†Œ/ìµœëŒ€ ìŠ¤ì¼€ì¼ ì²´í¬
                const minScale = 0.25;
                const maxScale = 5.0;
                
                // ì¶•ì†Œ ë²„íŠ¼ ìƒíƒœ
                if (this.scale <= minScale) {
                    this.zoomOut.classList.add('disabled');
                    this.zoomOut.title = 'ìµœì†Œ ë°°ìœ¨ì…ë‹ˆë‹¤';
                } else {
                    this.zoomOut.classList.remove('disabled');
                    this.zoomOut.title = 'ì¶•ì†Œ (Ctrl+-)';
                }
                
                // í™•ëŒ€ ë²„íŠ¼ ìƒíƒœ
                if (this.scale >= maxScale) {
                    this.zoomIn.classList.add('disabled');
                    this.zoomIn.title = 'ìµœëŒ€ ë°°ìœ¨ì…ë‹ˆë‹¤';
                } else {
                    this.zoomIn.classList.remove('disabled');
                    this.zoomIn.title = 'í™•ëŒ€ (Ctrl++)';
                }
            }
            
            updatePageInputWidth() {
                // ì „ì²´ í˜ì´ì§€ ìˆ˜ì˜ ìë¦¿ìˆ˜ ê³„ì‚°
                const digits = this.totalPages.toString().length;
                
                // ëª¨ë°”ì¼ ì—¬ë¶€ ì²´í¬
                const isMobile = window.innerWidth <= 768;
                
                if (isMobile) {
                    // ëª¨ë°”ì¼: ë” ì‘ì€ í¬ê¸°
                    const baseWidth = 12;
                    const charWidth = 7;
                    const calculatedWidth = baseWidth + (digits * charWidth);
                    const minWidth = 30;
                    const maxWidth = 60;
                    const finalWidth = Math.max(minWidth, Math.min(maxWidth, calculatedWidth));
                    this.pageInput.style.width = finalWidth + 'px';
                } else {
                    // ë°ìŠ¤í¬í†±: ê¸°ë³¸ í¬ê¸°
                    const baseWidth = 16;
                    const charWidth = 8;
                    const calculatedWidth = baseWidth + (digits * charWidth);
                    const minWidth = 35;
                    const maxWidth = 80;
                    const finalWidth = Math.max(minWidth, Math.min(maxWidth, calculatedWidth));
                    this.pageInput.style.width = finalWidth + 'px';
                }
            }
            
            updateZoomSelectWidth() {
                // ëª¨ë°”ì¼ ì—¬ë¶€ ì²´í¬
                const isMobile = window.innerWidth <= 768;
                
                if (isMobile) {
                    // ëª¨ë°”ì¼: ë” ì‘ì€ í¬ê¸°
                    const baseWidth = 12;
                    const textWidth = 20;
                    const percentWidth = 7;
                    const arrowWidth = 10;
                    const finalWidth = baseWidth + textWidth + percentWidth + arrowWidth;
                    this.zoomSelect.style.minWidth = finalWidth + 'px';
                    this.zoomSelect.style.width = finalWidth + 'px';
                } else {
                    // ë°ìŠ¤í¬í†±: ê¸°ë³¸ í¬ê¸°
                    const baseWidth = 16;
                    const textWidth = 24;
                    const percentWidth = 8;
                    const arrowWidth = 12;
                    const finalWidth = baseWidth + textWidth + percentWidth + arrowWidth;
                    this.zoomSelect.style.minWidth = finalWidth + 'px';
                    this.zoomSelect.style.width = finalWidth + 'px';
                }
            }

            updateZoomSelect(currentZoom) {
                const defaultOptions = [25, 50, 75, 100, 125, 150, 200, 300, 400, 500];
                
                let allOptions = [...defaultOptions];
                if (!allOptions.includes(currentZoom)) {
                    allOptions.push(currentZoom);
                    allOptions.sort((a, b) => a - b);
                }
                
                this.zoomSelect.innerHTML = '';
                allOptions.forEach(zoom => {
                    const option = document.createElement('option');
                    option.value = zoom;
                    option.textContent = zoom + '%';
                    if (zoom === currentZoom) {
                        option.selected = true;
                    }
                    this.zoomSelect.appendChild(option);
                });
            }

            async previousPage() {
                if (this.currentPage > 1) {
                    this.currentPage--;
                    await this.renderPage();
                    
                    // ë§ì¶¤ ëª¨ë“œì¸ ê²½ìš° ìƒˆ í˜ì´ì§€ì— ë§ê²Œ ìŠ¤ì¼€ì¼ ì¬ì¡°ì •
                    if (this.fitMode !== 'none') {
                        const page = await this.pdf.getPage(this.currentPage);
                        if (this.fitMode === 'width') {
                            await this.calculateFitToWidth(page);
                        } else if (this.fitMode === 'page') {
                            await this.calculateFitToPage(page);
                        }
                        // ìŠ¤ì¼€ì¼ ë³€ê²½ í›„ ë‹¤ì‹œ ë Œë”ë§
                        await this.renderPage();
                    }
                    
                    this.updateUI();
                    this.updateThumbnailSelection();
                    // ì´ì „ í˜ì´ì§€ë¡œ ì´ë™í•  ë•ŒëŠ” ë§¨ ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤
                    setTimeout(() => {
                        this.scrollToBottom();
                    }, 100);
                }
            }

            async nextPage() {
                if (this.currentPage < this.totalPages) {
                    this.currentPage++;
                    await this.renderPage();
                    
                    // ë§ì¶¤ ëª¨ë“œì¸ ê²½ìš° ìƒˆ í˜ì´ì§€ì— ë§ê²Œ ìŠ¤ì¼€ì¼ ì¬ì¡°ì •
                    if (this.fitMode !== 'none') {
                        const page = await this.pdf.getPage(this.currentPage);
                        if (this.fitMode === 'width') {
                            await this.calculateFitToWidth(page);
                        } else if (this.fitMode === 'page') {
                            await this.calculateFitToPage(page);
                        }
                        // ìŠ¤ì¼€ì¼ ë³€ê²½ í›„ ë‹¤ì‹œ ë Œë”ë§
                        await this.renderPage();
                    }
                    
                    this.updateUI();
                    this.updateThumbnailSelection();
                    // ë‹¤ìŒ í˜ì´ì§€ë¡œ ì´ë™í•  ë•ŒëŠ” ë§¨ ìœ„ë¡œ ìŠ¤í¬ë¡¤
                    this.scrollToTop();
                }
            }

            async goToPage() {
                const pageNum = parseInt(this.pageInput.value);
                if (pageNum >= 1 && pageNum <= this.totalPages && pageNum !== this.currentPage) {
                    this.currentPage = pageNum;
                    await this.renderPage();
                    
                    // ë§ì¶¤ ëª¨ë“œì¸ ê²½ìš° ìƒˆ í˜ì´ì§€ì— ë§ê²Œ ìŠ¤ì¼€ì¼ ì¬ì¡°ì •
                    if (this.fitMode !== 'none') {
                        const page = await this.pdf.getPage(this.currentPage);
                        if (this.fitMode === 'width') {
                            await this.calculateFitToWidth(page);
                        } else if (this.fitMode === 'page') {
                            await this.calculateFitToPage(page);
                        }
                        // ìŠ¤ì¼€ì¼ ë³€ê²½ í›„ ë‹¤ì‹œ ë Œë”ë§
                        await this.renderPage();
                    }
                    
                    this.updateUI();
                    this.updateThumbnailSelection();
                    this.scrollToTop();
                } else {
                    this.pageInput.value = this.currentPage;
                }
            }

            scrollToTop() {
                // ë¶€ë“œëŸ¬ìš´ ìŠ¤í¬ë¡¤ë¡œ ë§¨ ìœ„ë¡œ ì´ë™
                this.pdfContainer.scrollTo({
                    top: 0,
                    left: this.pdfContainer.scrollLeft, // ê°€ë¡œ ìŠ¤í¬ë¡¤ì€ ìœ ì§€
                    behavior: 'smooth'
                });
            }

            scrollToBottom() {
                // ë¶€ë“œëŸ¬ìš´ ìŠ¤í¬ë¡¤ë¡œ ë§¨ ì•„ë˜ë¡œ ì´ë™
                this.pdfContainer.scrollTo({
                    top: this.pdfContainer.scrollHeight,
                    left: this.pdfContainer.scrollLeft, // ê°€ë¡œ ìŠ¤í¬ë¡¤ì€ ìœ ì§€
                    behavior: 'smooth'
                });
            }

            // í…ìŠ¤íŠ¸ê°€ ì„ íƒë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
            hasTextSelection() {
                const selection = window.getSelection();
                return selection && selection.toString().trim().length > 0;
            }

            // ì„ íƒëœ í…ìŠ¤íŠ¸ë¥¼ í´ë¦½ë³´ë“œì— ë³µì‚¬
            async copySelectedText() {
                const selection = window.getSelection();
                const selectedText = selection.toString();
                
                if (selectedText.trim().length > 0) {
                    try {
                        await navigator.clipboard.writeText(selectedText);
                        this.showToastMessage('âœ… í…ìŠ¤íŠ¸ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
                        return true;
                    } catch (err) {
                        console.error('í…ìŠ¤íŠ¸ ë³µì‚¬ ì‹¤íŒ¨:', err);
                        return false;
                    }
                }
                return false;
            }

            // ì´ë¯¸ì§€ë¥¼ í´ë¦½ë³´ë“œì— ë³µì‚¬ - í˜„ì¬ í‘œì‹œëœ ì´ë¯¸ì§€ ì‚¬ìš©
            async copyImageToClipboard() {
                if (!this.pdf) return false;

                try {
                    // í˜„ì¬ í˜ì´ì§€ ê°€ì ¸ì˜¤ê¸°
                    const page = await this.pdf.getPage(this.currentPage);
                    
                    // ê³ ì •ëœ ê³ í’ˆì§ˆ ë°°ìœ¨ë¡œ ë Œë”ë§
                    const fixedScale = this.renderScale; // 3.0 ì‚¬ìš©
                    const viewport = page.getViewport({scale: fixedScale});
                    
                    // ì„ì‹œ Canvas ìƒì„± (í´ë¦½ë³´ë“œ ë³µì‚¬ìš©)
                    const tempCanvas = document.createElement('canvas');
                    const tempCtx = tempCanvas.getContext('2d');
                    
                    tempCanvas.width = viewport.width;
                    tempCanvas.height = viewport.height;
                    
                    // ì„ì‹œ ìº”ë²„ìŠ¤ì— ë Œë”ë§
                    const renderContext = {
                        canvasContext: tempCtx,
                        viewport: viewport
                    };
                    
                    // ë³„ë„ ë Œë”ë§ ì‘ì—…ìœ¼ë¡œ ì‹¤í–‰
                    const tempRenderTask = page.render(renderContext);
                    await tempRenderTask.promise;
                    
                    // Canvasë¥¼ í´ë¦½ë³´ë“œì— ë³µì‚¬
                    tempCanvas.toBlob(async (blob) => {
                        const item = new ClipboardItem({'image/png': blob});
                        await navigator.clipboard.write([item]);
                        this.showToastMessage('âœ… ì´ë¯¸ì§€ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    }, 'image/png', 1.0);
                    
                    return true;
                } catch (err) {
                    console.error('ì´ë¯¸ì§€ ë³µì‚¬ ì‹¤íŒ¨:', err);
                    this.showToastMessage('âŒ ì´ë¯¸ì§€ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    return false;
                }
            }

            // ìŠ¤ë§ˆíŠ¸ ë³µì‚¬ - í…ìŠ¤íŠ¸ ì„ íƒë˜ì–´ ìˆìœ¼ë©´ í…ìŠ¤íŠ¸, ì•„ë‹ˆë©´ ì´ë¯¸ì§€
            async smartCopy() {
                if (this.hasTextSelection()) {
                    return await this.copySelectedText();
                } else {
                    return await this.copyImageToClipboard();
                }
            }

            // PDF ë‚´ ëª¨ë“  í…ìŠ¤íŠ¸ ì„ íƒ
            selectAllPDFText() {
                const textSpans = this.textLayer.querySelectorAll('span');
                if (textSpans.length === 0) return;

                const selection = window.getSelection();
                selection.removeAllRanges();
                
                const range = document.createRange();
                range.setStartBefore(textSpans[0]);
                range.setEndAfter(textSpans[textSpans.length - 1]);
                
                selection.addRange(range);
                this.showToastMessage('ğŸ“„ PDF í…ìŠ¤íŠ¸ ì „ì²´ ì„ íƒë¨');
            }

            showToastMessage(message) {
                // ìƒˆë¡œìš´ í† ìŠ¤íŠ¸ ìš”ì†Œ ìƒì„±
                const toast = document.createElement('div');
                toast.className = 'toast';
                toast.textContent = message;
                
                // ì»¨í…Œì´ë„ˆì— ì¶”ê°€
                this.toastContainer.appendChild(toast);
                
                // ì¦‰ì‹œ í‘œì‹œ (ì• ë‹ˆë©”ì´ì…˜ íŠ¸ë¦¬ê±°ë¥¼ ìœ„í•´ ì•½ê°„ì˜ ë”œë ˆì´)
                setTimeout(() => {
                    toast.classList.add('show');
                }, 10);
                
                // 3ì´ˆ í›„ì— ìˆ¨ê¸°ê¸° ì‹œì‘
                setTimeout(() => {
                    toast.classList.add('hide');
                    toast.classList.remove('show');
                    
                    // ì• ë‹ˆë©”ì´ì…˜ ì™„ë£Œ í›„ ìš”ì†Œ ì œê±°
                    setTimeout(() => {
                        if (toast.parentNode) {
                            this.toastContainer.removeChild(toast);
                        }
                    }, 300);
                }, 3000);
            }
            
            // ìº¡ì³ ëª¨ë“œ í† ê¸€
            toggleCaptureMode() {
                this.isCaptureMode = !this.isCaptureMode;
                
                if (this.isCaptureMode) {
                    // ìº¡ì³ ëª¨ë“œ í™œì„±í™” (ì‚¬ì´ë“œë°”ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€)
                    this.captureBtn.classList.add('capture-mode');
                    this.captureBtn.title = 'ìº¡ì³ ëª¨ë“œ ì¢…ë£Œ (ESC)';
                    this.captureOverlay.classList.add('active');
                    this.captureGuide.classList.add('show');
                    
                    // í…ìŠ¤íŠ¸ ì„ íƒ ë¹„í™œì„±í™”
                    this.textLayer.style.pointerEvents = 'none';
                    
                    this.showToastMessage('âœ‚ï¸ ìº¡ì³ ëª¨ë“œ í™œì„±í™”! ë“œë˜ê·¸í•˜ì—¬ ì˜ì—­ì„ ì„ íƒí•˜ì„¸ìš”');
                } else {
                    // ìº¡ì³ ëª¨ë“œ ë¹„í™œì„±í™”
                    this.exitCaptureMode();
                }
            }
            
            exitCaptureMode() {
                this.isCaptureMode = false;
                this.isSelecting = false;
                
                // UI ë³µì›
                this.captureBtn.classList.remove('capture-mode');
                this.captureBtn.title = 'ì˜ì—­ ìº¡ì³ (Ctrl+Shift+X)';
                this.captureOverlay.classList.remove('active');
                this.captureGuide.classList.remove('show');
                this.selectionArea.style.display = 'none';
                
                // í…ìŠ¤íŠ¸ ì„ íƒ ë³µì›
                this.textLayer.style.pointerEvents = 'auto';
            }
            
            startSelection(e) {
                if (!this.isCaptureMode) return;
                
                e.preventDefault();
                this.isSelecting = true;
                
                // ìº¡ì³ ì˜¤ë²„ë ˆì´ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì •í™•í•œ ì¢Œí‘œ ê³„ì‚°
                const overlayRect = this.captureOverlay.getBoundingClientRect();
                this.selectionStart.x = e.clientX - overlayRect.left;
                this.selectionStart.y = e.clientY - overlayRect.top;
                this.selectionEnd.x = this.selectionStart.x;
                this.selectionEnd.y = this.selectionStart.y;
                
                this.captureGuide.classList.remove('show');
                this.selectionArea.style.display = 'block';
                this.updateSelectionArea();
            }
            
            updateSelection(e) {
                if (!this.isCaptureMode || !this.isSelecting) return;
                
                e.preventDefault();
                // ìº¡ì³ ì˜¤ë²„ë ˆì´ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì •í™•í•œ ì¢Œí‘œ ê³„ì‚°
                const overlayRect = this.captureOverlay.getBoundingClientRect();
                this.selectionEnd.x = e.clientX - overlayRect.left;
                this.selectionEnd.y = e.clientY - overlayRect.top;
                
                this.updateSelectionArea();
            }
            
            updateSelectionArea() {
                const left = Math.min(this.selectionStart.x, this.selectionEnd.x);
                const top = Math.min(this.selectionStart.y, this.selectionEnd.y);
                const width = Math.abs(this.selectionEnd.x - this.selectionStart.x);
                const height = Math.abs(this.selectionEnd.y - this.selectionStart.y);
                
                this.selectionArea.style.left = left + 'px';
                this.selectionArea.style.top = top + 'px';
                this.selectionArea.style.width = width + 'px';
                this.selectionArea.style.height = height + 'px';
            }
            
            async endSelection(e) {
                if (!this.isCaptureMode || !this.isSelecting) return;
                
                e.preventDefault();
                this.isSelecting = false;
                
                const width = Math.abs(this.selectionEnd.x - this.selectionStart.x);
                const height = Math.abs(this.selectionEnd.y - this.selectionStart.y);
                
                // ìµœì†Œ í¬ê¸° ì²´í¬ (10x10 í”½ì…€)
                if (width < 10 || height < 10) {
                    this.showToastMessage('âŒ ì„ íƒ ì˜ì—­ì´ ë„ˆë¬´ ì‘ìŠµë‹ˆë‹¤');
                    this.selectionArea.style.display = 'none';
                    this.captureGuide.classList.add('show');
                    return;
                }
                
                // ì„ íƒ ì˜ì—­ ìº¡ì³
                await this.captureSelectedArea();
                this.exitCaptureMode();
            }
            
            cancelSelection(e) {
                if (!this.isCaptureMode) return;
                
                this.isSelecting = false;
                this.selectionArea.style.display = 'none';
                this.captureGuide.classList.add('show');
            }
            
            async captureSelectedArea() {
                try {
                    if (!this.pdf) return;
                    
                    // ì„ íƒ ì˜ì—­ ì¢Œí‘œ (ì˜¤ë²„ë ˆì´ ê¸°ì¤€)
                    const selectLeft = Math.min(this.selectionStart.x, this.selectionEnd.x);
                    const selectTop = Math.min(this.selectionStart.y, this.selectionEnd.y);
                    const selectWidth = Math.abs(this.selectionEnd.x - this.selectionStart.x);
                    const selectHeight = Math.abs(this.selectionEnd.y - this.selectionStart.y);
                    
                    // ì‹¤ì œ DOM ìš”ì†Œë“¤ì˜ ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°
                    const overlayRect = this.captureOverlay.getBoundingClientRect();
                    const imageRect = this.pdfImage.getBoundingClientRect();
                    
                    // ì˜¤ë²„ë ˆì´ì—ì„œ ì´ë¯¸ì§€ë¡œì˜ ì¢Œí‘œ ë³€í™˜
                    const imageOffsetX = imageRect.left - overlayRect.left;
                    const imageOffsetY = imageRect.top - overlayRect.top;
                    
                    // ì„ íƒ ì˜ì—­ì„ ì´ë¯¸ì§€ ì¢Œí‘œë¡œ ë³€í™˜
                    const imageLeft = selectLeft - imageOffsetX;
                    const imageTop = selectTop - imageOffsetY;
                    
                    // ì´ë¯¸ì§€ ë²”ìœ„ ë‚´ë¡œ í´ë¦¬í•‘
                    const cropLeft = Math.max(0, imageLeft);
                    const cropTop = Math.max(0, imageTop);
                    const cropRight = Math.min(imageRect.width, imageLeft + selectWidth);
                    const cropBottom = Math.min(imageRect.height, imageTop + selectHeight);
                    
                    const cropWidth = cropRight - cropLeft;
                    const cropHeight = cropBottom - cropTop;
                    
                    // ìœ íš¨í•œ ì˜ì—­ì¸ì§€ í™•ì¸
                    if (cropWidth <= 5 || cropHeight <= 5) {
                        this.showToastMessage('âŒ ì„ íƒ ì˜ì—­ì´ PDF ë²”ìœ„ ë‚´ì— ì—†ê±°ë‚˜ ë„ˆë¬´ ì‘ìŠµë‹ˆë‹¤');
                        return;
                    }
                    
                    // í˜„ì¬ í˜ì´ì§€ë¥¼ ê³ í’ˆì§ˆë¡œ ë Œë”ë§
                    const page = await this.pdf.getPage(this.currentPage);
                    const highQualityScale = this.renderScale; // 3.0
                    const viewport = page.getViewport({scale: highQualityScale});
                    
                    // ì„ì‹œ ìº”ë²„ìŠ¤ ìƒì„± ë° ë Œë”ë§
                    const tempCanvas = document.createElement('canvas');
                    const tempCtx = tempCanvas.getContext('2d');
                    
                    tempCanvas.width = viewport.width;
                    tempCanvas.height = viewport.height;
                    
                    const renderContext = {
                        canvasContext: tempCtx,
                        viewport: viewport
                    };
                    
                    const renderTask = page.render(renderContext);
                    await renderTask.promise;
                    
                    // ì‹¤ì œ í‘œì‹œëœ ì´ë¯¸ì§€ í¬ê¸°ì™€ ë Œë”ë§ëœ ìº”ë²„ìŠ¤ í¬ê¸°ì˜ ë¹„ìœ¨ ê³„ì‚°
                    const scaleRatio = viewport.width / imageRect.width;
                    
                    // ìº”ë²„ìŠ¤ì—ì„œ ì˜ë¼ë‚¼ ì˜ì—­ ê³„ì‚°
                    const canvasCropX = cropLeft * scaleRatio;
                    const canvasCropY = cropTop * scaleRatio;
                    const canvasCropWidth = cropWidth * scaleRatio;
                    const canvasCropHeight = cropHeight * scaleRatio;
                    
                    // ìµœì¢… ìº”ë²„ìŠ¤ ìƒì„±
                    const finalCanvas = document.createElement('canvas');
                    const finalCtx = finalCanvas.getContext('2d');
                    
                    finalCanvas.width = canvasCropWidth;
                    finalCanvas.height = canvasCropHeight;
                    
                    // ì„ íƒ ì˜ì—­ë§Œ ë³µì‚¬
                    finalCtx.drawImage(
                        tempCanvas,
                        canvasCropX, canvasCropY, canvasCropWidth, canvasCropHeight,
                        0, 0, canvasCropWidth, canvasCropHeight
                    );
                    
                    // í´ë¦½ë³´ë“œì— ë³µì‚¬
                    finalCanvas.toBlob(async (blob) => {
                        const item = new ClipboardItem({'image/png': blob});
                        await navigator.clipboard.write([item]);
                        this.showToastMessage('âœ‚ï¸ ì„ íƒ ì˜ì—­ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    }, 'image/png', 1.0);
                    
                } catch (error) {
                    console.error('ì˜ì—­ ìº¡ì³ ì‹¤íŒ¨:', error);
                    this.showToastMessage('âŒ ì˜ì—­ ìº¡ì³ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
                }
            }
            
            async generateThumbnails() {
                if (!this.pdf) return;
                
                this.loadingThumbnails.textContent = 'ì¸ë„¤ì¼ ìƒì„± ì¤‘...';
                this.thumbnails = [];
                this.thumbnailsContainer.innerHTML = '<div class="loading-thumbnails">ì¸ë„¤ì¼ ìƒì„± ì¤‘...</div>';
                
                try {
                    // ì¸ë„¤ì¼ì„ ìˆœì°¨ì ìœ¼ë¡œ ìƒì„±
                    for (let pageNum = 1; pageNum <= this.totalPages; pageNum++) {
                        await this.createThumbnail(pageNum);
                    }
                    
                    // ë¡œë”© ë©”ì‹œì§€ ì œê±°
                    const loadingDiv = this.thumbnailsContainer.querySelector('.loading-thumbnails');
                    if (loadingDiv) {
                        loadingDiv.remove();
                    }
                    
                    // í˜„ì¬ í˜ì´ì§€ í™œì„±í™”
                    this.updateThumbnailSelection();
                    
                } catch (error) {
                    console.error('ì¸ë„¤ì¼ ìƒì„± ì‹¤íŒ¨:', error);
                    this.loadingThumbnails.textContent = 'ì¸ë„¤ì¼ ìƒì„± ì‹¤íŒ¨';
                }
            }
            
            async createThumbnail(pageNum) {
                try {
                    const page = await this.pdf.getPage(pageNum);
                    const scale = 0.3; // ì¸ë„¤ì¼ í¬ê¸°
                    const viewport = page.getViewport({scale: scale});
                    
                    // ì¸ë„¤ì¼ ìº”ë²„ìŠ¤ ìƒì„±
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;
                    
                    // ì¸ë„¤ì¼ ë Œë”ë§
                    const renderContext = {
                        canvasContext: ctx,
                        viewport: viewport
                    };
                    
                    const renderTask = page.render(renderContext);
                    await renderTask.promise;
                    
                    // ì¸ë„¤ì¼ ì•„ì´í…œ ìƒì„±
                    const thumbnailItem = document.createElement('div');
                    thumbnailItem.className = 'thumbnail-item';
                    thumbnailItem.dataset.page = pageNum;
                    
                    // ìº”ë²„ìŠ¤ ì¶”ê°€
                    canvas.className = 'thumbnail-canvas';
                    thumbnailItem.appendChild(canvas);
                    
                    // í˜ì´ì§€ ë¼ë²¨ ì¶”ê°€
                    const label = document.createElement('div');
                    label.className = 'thumbnail-label';
                    label.textContent = pageNum;
                    thumbnailItem.appendChild(label);
                    
                    // í´ë¦­ ì´ë²¤íŠ¸
                    thumbnailItem.addEventListener('click', () => this.goToPageFromThumbnail(pageNum));
                    
                    // ì»¨í…Œì´ë„ˆì— ì¶”ê°€
                    this.thumbnailsContainer.appendChild(thumbnailItem);
                    this.thumbnails[pageNum - 1] = thumbnailItem;
                    
                } catch (error) {
                    console.error(`í˜ì´ì§€ ${pageNum} ì¸ë„¤ì¼ ìƒì„± ì‹¤íŒ¨:`, error);
                }
            }
            
            async goToPageFromThumbnail(pageNum) {
                if (pageNum >= 1 && pageNum <= this.totalPages && pageNum !== this.currentPage) {
                    this.currentPage = pageNum;
                    await this.renderPage();
                    
                    // ë§ì¶¤ ëª¨ë“œì¸ ê²½ìš° ìƒˆ í˜ì´ì§€ì— ë§ê²Œ ìŠ¤ì¼€ì¼ ì¬ì¡°ì •
                    if (this.fitMode !== 'none') {
                        const page = await this.pdf.getPage(this.currentPage);
                        if (this.fitMode === 'width') {
                            await this.calculateFitToWidth(page);
                        } else if (this.fitMode === 'page') {
                            await this.calculateFitToPage(page);
                        }
                        // ìŠ¤ì¼€ì¼ ë³€ê²½ í›„ ë‹¤ì‹œ ë Œë”ë§
                        await this.renderPage();
                    }
                    
                    this.updateUI();
                    this.updateThumbnailSelection();
                    this.scrollToTop();
                }
            }
            
            updateThumbnailSelection() {
                // ì¸ë„¤ì¼ì´ ì—†ìœ¼ë©´ ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•ŠìŒ
                if (!this.thumbnails || this.thumbnails.length === 0) return;
                
                // ëª¨ë“  ì¸ë„¤ì¼ì˜ active í´ë˜ìŠ¤ ì œê±°
                this.thumbnails.forEach((thumbnail, index) => {
                    if (thumbnail) {
                        thumbnail.classList.remove('active');
                    }
                });
                
                // í˜„ì¬ í˜ì´ì§€ ì¸ë„¤ì¼ì— active í´ë˜ìŠ¤ ì¶”ê°€
                if (this.thumbnails[this.currentPage - 1]) {
                    this.thumbnails[this.currentPage - 1].classList.add('active');
                    
                    // í˜„ì¬ ì¸ë„¤ì¼ì´ ë³´ì´ë„ë¡ ìŠ¤í¬ë¡¤ (ì¸ë„¤ì¼ ì„¹ì…˜ì´ ì—´ë ¤ìˆì„ ë•Œë§Œ)
                    if (this.isThumbnailsOpen) {
                        this.thumbnails[this.currentPage - 1].scrollIntoView({
                            behavior: 'smooth',
                            block: 'nearest'
                        });
                    }
                }
            }

            handleWheel(e) {
                // ìº¡ì³ ëª¨ë“œì—ì„œëŠ” íœ  ì´ë²¤íŠ¸ ë¬´ì‹œ
                if (this.isCaptureMode) return;
                
                if (e.ctrlKey) {
                    e.preventDefault();
                    
                    // ë§ˆìš°ìŠ¤ íœ  í™•ëŒ€/ì¶•ì†Œ - ì¤‘ì•™ ê¸°ì¤€
                    if (!this.isZooming) {
                        this.startZooming();
                    }
                    
                    // í™•ëŒ€/ì¶•ì†Œ íŒ©í„° ê³„ì‚°
                    const zoomFactor = e.deltaY > 0 ? 0.9 : 1.1;
                    let newScale = this.scale * zoomFactor;
                    newScale = Math.max(0.25, Math.min(5.0, newScale));
                    
                    if (newScale !== this.scale) {
                        // í˜„ì¬ ì»¨í…Œì´ë„ˆ ì¤‘ì•™ ì¢Œí‘œ ê³„ì‚°
                        const container = this.pdfContainer;
                        const containerCenterX = container.clientWidth / 2;
                        const containerCenterY = container.clientHeight / 2;
                        
                        // í˜„ì¬ ìŠ¤í¬ë¡¤ ìœ„ì¹˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì¤‘ì•™ì ì˜ ë¬¸ì„œ ì¢Œí‘œ ê³„ì‚°
                        const currentCenterX = container.scrollLeft + containerCenterX;
                        const currentCenterY = container.scrollTop + containerCenterY;
                        
                        // ìŠ¤ì¼€ì¼ ë¹„ìœ¨ ê³„ì‚°
                        const scaleRatio = newScale / this.scale;
                        
                        // ë‚´ë¶€ ìƒíƒœ ì—…ë°ì´íŠ¸
                        this.scale = newScale;
                        this.fitMode = 'none';
                        this.updateFitToggle(); // CSS í´ë˜ìŠ¤ ì—…ë°ì´íŠ¸ í¬í•¨
                        this.updateUI();
                        
                        // ì´ë¯¸ì§€ì™€ ìŠ¤í¬ë¡¤ ì˜ì—­ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
                        this.updateImageSize();
                        this.updateScrollAreaForZoom();
                        
                        // ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ì¡°ì • (ì¤‘ì•™ ê¸°ì¤€ ìœ ì§€)
                        const newCenterX = currentCenterX * scaleRatio;
                        const newCenterY = currentCenterY * scaleRatio;
                        
                        const newScrollLeft = newCenterX - containerCenterX;
                        const newScrollTop = newCenterY - containerCenterY;
                        
                        // ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ì„¤ì •
                        container.scrollLeft = Math.max(0, Math.min(newScrollLeft, container.scrollWidth - container.clientWidth));
                        container.scrollTop = Math.max(0, Math.min(newScrollTop, container.scrollHeight - container.clientHeight));
                        
                        // í…ìŠ¤íŠ¸ ë ˆì´ì–´ë§Œ ë””ë°”ìš´ìŠ¤ë¡œ ì—…ë°ì´íŠ¸
                        this.scheduleTextLayerUpdate();
                        
                        // ì¤Œ ì™„ë£Œ
                        this.isZooming = false;
                    }
                    
                } else {
                    // ì¼ë°˜ ìŠ¤í¬ë¡¤ - ìŠ¤í¬ë¡¤ ëì— ë„ë‹¬í–ˆì„ ë•Œë§Œ í˜ì´ì§€ ì „í™˜
                    const container = this.pdfContainer;
                    const scrollTop = container.scrollTop;
                    const scrollHeight = container.scrollHeight;
                    const clientHeight = container.clientHeight;
                    
                    // ì„¸ë¡œ ìŠ¤í¬ë¡¤ ìƒíƒœ í™•ì¸
                    const canScrollVertically = scrollHeight > clientHeight;
                    const isAtTop = scrollTop <= 10;
                    const isAtBottom = scrollTop + clientHeight >= scrollHeight - 10;
                    
                    // ìœ„ë¡œ ìŠ¤í¬ë¡¤í•˜ë©´ì„œ ë§¨ ìœ„ì— ìˆê³  ì´ì „ í˜ì´ì§€ê°€ ìˆëŠ” ê²½ìš°
                    if (e.deltaY < 0 && isAtTop && this.currentPage > 1) {
                        e.preventDefault();
                        this.previousPage();
                    } 
                    // ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤í•˜ë©´ì„œ ë§¨ ì•„ë˜ì— ìˆê³  ë‹¤ìŒ í˜ì´ì§€ê°€ ìˆëŠ” ê²½ìš°
                    else if (e.deltaY > 0 && isAtBottom && this.currentPage < this.totalPages) {
                        e.preventDefault();
                        this.nextPage();
                    }
                    // ê·¸ ì™¸ì˜ ê²½ìš°ëŠ” ì¼ë°˜ ìŠ¤í¬ë¡¤ ë™ì‘ í—ˆìš©
                }
            }

            async handleResize() {
                // íˆ´ë°” ìš”ì†Œ í¬ê¸° ì¬ì¡°ì •
                if (this.totalPages > 0) {
                    this.updatePageInputWidth();
                    this.updateZoomSelectWidth();
                }
                
                if (this.fitMode !== 'none' && this.pdf) {
                    this.startZooming();
                    
                    // í˜„ì¬ ë§ì¶¤ ëª¨ë“œì— ë”°ë¼ ìƒˆë¡œìš´ ìŠ¤ì¼€ì¼ ê³„ì‚°
                    const page = await this.pdf.getPage(this.currentPage);
                    let newScale;
                    
                    if (this.fitMode === 'width') {
                        newScale = await this.calculateFitToWidthScale(page);
                    } else if (this.fitMode === 'page') {
                        newScale = await this.calculateFitToPageScale(page);
                    } else {
                        return; // fitModeê°€ 'none'ì´ë©´ ë¦¬ì‚¬ì´ì¦ˆ ë¬´ì‹œ
                    }
                    
                    // ìŠ¤ì¼€ì¼ ì—…ë°ì´íŠ¸ (ë Œë”ë§ ì—†ì´)
                    this.scale = newScale;
                    this.updateFitToggle();
                    this.updateUI();
                    this.updateImageSize();
                    this.updateScrollAreaForZoom(); // í˜ì´ì§€ ë§ì¶¤ ëª¨ë“œì—ì„œ ìŠ¤í¬ë¡¤ ë°©ì§€ ì ìš©
                    this.scheduleTextLayerUpdate();
                    this.isZooming = false;
                }
            }

            async handleKeyboard(e) {
                if (!this.pdf) return;

                // PDF ë·°ì–´ê°€ í™œì„±í™”ëœ ìƒíƒœì—ì„œë§Œ í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ ë™ì‘
                if (this.pdfViewer.style.display === 'none') return;

                switch(e.key) {
                    case 'Escape':
                        // ESC í‚¤ë¡œ ëª¨ë‹¬, ìº¡ì³ ëª¨ë“œ ë˜ëŠ” ì‚¬ì´ë“œë°” ì¢…ë£Œ
                        if (this.propertiesModal.classList.contains('show')) {
                            e.preventDefault();
                            this.hideDocumentProperties();
                        } else if (this.isCaptureMode) {
                            e.preventDefault();
                            this.exitCaptureMode();
                            this.showToastMessage('âœ‚ï¸ ìº¡ì³ ëª¨ë“œê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤');
                        } else if (this.isIconPanelOpen) {
                            // ì‚¬ì´ë“œë°”ê°€ ì—´ë ¤ìˆìœ¼ë©´ ì „ì²´ ë‹«ê¸°
                            e.preventDefault();
                            this.toggleIconPanel();
                            this.showToastMessage('ğŸ“„ ì‚¬ì´ë“œë°”ê°€ ë‹«í˜”ìŠµë‹ˆë‹¤');
                        }
                        break;
                    case 'b':
                    case 'B':
                        if (e.ctrlKey && !this.isCaptureMode) {
                            e.preventDefault();
                            this.toggleIconPanel();
                            const message = this.isIconPanelOpen ? 'ğŸ“„ ì‚¬ì´ë“œë°”ê°€ ì—´ë ¸ìŠµë‹ˆë‹¤' : 'ğŸ“„ ì‚¬ì´ë“œë°”ê°€ ë‹«í˜”ìŠµë‹ˆë‹¤';
                            this.showToastMessage(message);
                        }
                        break;
                    case 'x':
                    case 'X':
                        if (e.ctrlKey && e.shiftKey && !this.isCaptureMode) {
                            e.preventDefault();
                            this.toggleCaptureMode();
                            if (this.isCaptureMode) {
                                // ìº¡ì³ ëª¨ë“œ í™œì„±í™” ë©”ì‹œì§€ëŠ” toggleCaptureModeì—ì„œ ì²˜ë¦¬
                            } else {
                                this.showToastMessage('âœ‚ï¸ ìº¡ì³ ëª¨ë“œê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤');
                            }
                        }
                        break;
                    case 'ArrowLeft':
                        // ì™¼ìª½ í™”ì‚´í‘œ - ì´ì „ í˜ì´ì§€ (ìŠ¤í¬ë¡¤ ìƒíƒœ ë¬´ê´€)
                        if (!this.isCaptureMode) {
                            e.preventDefault();
                            await this.previousPage();
                        }
                        break;
                    case 'ArrowRight':
                        // ì˜¤ë¥¸ìª½ í™”ì‚´í‘œ - ë‹¤ìŒ í˜ì´ì§€ (ìŠ¤í¬ë¡¤ ìƒíƒœ ë¬´ê´€)
                        if (!this.isCaptureMode) {
                            e.preventDefault();
                            await this.nextPage();
                        }
                        break;
                    case 'ArrowUp':
                        // ìœ„ìª½ í™”ì‚´í‘œ - ìŠ¤í¬ë¡¤ì´ ë§¨ ìœ„ë©´ ì´ì „ í˜ì´ì§€
                        if (!this.isCaptureMode && this.pdfContainer.scrollTop <= 10 && this.currentPage > 1) {
                            e.preventDefault();
                            await this.previousPage();
                        }
                        // ê·¸ ì™¸ì—ëŠ” ê¸°ë³¸ ìŠ¤í¬ë¡¤ ë™ì‘
                        break;
                    case 'ArrowDown':
                        // ì•„ë˜ìª½ í™”ì‚´í‘œ - ìŠ¤í¬ë¡¤ì´ ë§¨ ì•„ë˜ë©´ ë‹¤ìŒ í˜ì´ì§€
                        if (!this.isCaptureMode) {
                            const container = this.pdfContainer;
                            if (container.scrollTop + container.clientHeight >= container.scrollHeight - 10 && this.currentPage < this.totalPages) {
                                e.preventDefault();
                                await this.nextPage();
                            }
                        }
                        // ê·¸ ì™¸ì—ëŠ” ê¸°ë³¸ ìŠ¤í¬ë¡¤ ë™ì‘
                        break;
                    case 'i':
                    case 'I':
                        if (e.ctrlKey && !this.isCaptureMode) {
                            e.preventDefault();
                            // ë¬¸ì„œ ì†ì„± ì°½ í† ê¸€
                            if (this.propertiesModal.classList.contains('show')) {
                                this.hideDocumentProperties();
                            } else {
                                this.showDocumentProperties();
                            }
                        }
                        break;
                    case 'c':
                    case 'C':
                        if (e.ctrlKey && !this.isCaptureMode) {
                            e.preventDefault();
                            await this.smartCopy();
                        }
                        break;
                    case 'a':
                    case 'A':
                        if (e.ctrlKey && !this.isCaptureMode) {
                            // í˜ì´ì§€ ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤ê°€ ìˆìœ¼ë©´ í•´ë‹¹ í•„ë“œ ë‚´ìš©ë§Œ ì „ì²´ ì„ íƒ
                            if (document.activeElement === this.pageInput) {
                                // ê¸°ë³¸ ë™ì‘ í—ˆìš© (í˜ì´ì§€ ì…ë ¥ í•„ë“œ ì „ì²´ ì„ íƒ)
                                return;
                            } else {
                                // PDF í…ìŠ¤íŠ¸ ì „ì²´ ì„ íƒ
                                e.preventDefault();
                                this.selectAllPDFText();
                            }
                        }
                        break;
                    case '=':
                    case '+':
                        if (e.ctrlKey && !this.isCaptureMode) {
                            e.preventDefault();
                            await this.zoomPage(1.25);
                        }
                        break;
                    case '-':
                        if (e.ctrlKey && !this.isCaptureMode) {
                            e.preventDefault();
                            await this.zoomPage(0.8);
                        }
                        break;
                }
            }
        }

        // ì•± ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¦‰ì‹œ ì‹œìŠ¤í…œ í…Œë§ˆ ì ìš©
            applyInitialSystemTheme();
            
            // PDF ë·°ì–´ ì´ˆê¸°í™”
            new PDFClipboard();
        });

        // ì´ˆê¸° ì‹œìŠ¤í…œ í…Œë§ˆ ì ìš© (í˜ì´ì§€ ë¡œë“œ ì‹œ)
        function applyInitialSystemTheme() {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                // ì‹œìŠ¤í…œì´ ë‹¤í¬ëª¨ë“œë©´ ê¸°ë³¸ ìƒíƒœ ìœ ì§€ (ë‹¤í¬ëª¨ë“œ)
                document.body.classList.remove('light-theme');
            } else {
                // ì‹œìŠ¤í…œì´ ë¼ì´íŠ¸ëª¨ë“œë©´ ë¼ì´íŠ¸ í…Œë§ˆ ì ìš©
                document.body.classList.add('light-theme');
            }
            
            // ì‹œìŠ¤í…œ í…Œë§ˆ ë³€ê²½ ê°ì§€
            if (window.matchMedia) {
                const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
                mediaQuery.addEventListener('change', (e) => {
                    // PDF ë·°ì–´ê°€ ë¡œë“œë˜ì§€ ì•Šì€ ìƒíƒœì—ì„œë„ í…Œë§ˆ ë³€ê²½ ì ìš©
                    if (e.matches) {
                        document.body.classList.remove('light-theme');
                    } else {
                        document.body.classList.add('light-theme');
                    }
                });
            }
        }
    </script>
</body>
</html>
